
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>nuts!</title>
  <meta name="author" content="chamila">

  
  <meta name="description" content="It&rsquo;s 2016. Kubernetes needs no introduction. Neither does WSO2, so let&rsquo;s get to the point. Let&rsquo;s run WSO2 Identity Server on &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chamilad.github.io">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="nuts!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab:300' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
  

</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <a href="/"><h2>nuts!</h2></a>
  
    <h1>Ramblings on Cloud Computing, Middleware and Beer</h1>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chamilad.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/09/running-wso2-products-on-kubernetes/">Running WSO2 Products on Kubernetes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-09T16:15:13+05:30" pubdate data-updated="true">Feb 9<sup>th</sup>, 2016</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/docker/'>docker</a> <a class='category label label-primary' href='/blog/categories/identity-server/'>identity server</a> <a class='category label label-primary' href='/blog/categories/kubernetes/'>kubernetes</a> <a class='category label label-primary' href='/blog/categories/puppet/'>puppet</a> <a class='category label label-primary' href='/blog/categories/wso2/'>wso2</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s 2016. Kubernetes needs no introduction. Neither does WSO2, so let&rsquo;s get to the point. Let&rsquo;s run WSO2 Identity Server on Kubernetes!</p>

<h1>You&rsquo;ll need a basic understanding of</h1>

<ol>
<li><a href="https://docs.docker.com/linux/">Docker</a></li>
<li><a href="http://kubernetes.io/gettingstarted/">Kubernetes</a></li>
<li><a href="https://puppetlabs.com/presentations/getting-started-puppet">Puppet</a></li>
</ol>


<h1>Checkout</h1>

<p>the following repositories.</p>

<ol>
<li>WSO2 Kubernetes Artifacts &ndash; <code>git clone https://github.com/wso2/kubernetes-artifacts.git</code></li>
<li>WSO2 Puppet Modules &ndash; <code>git clone https://github.com/wso2/puppet-modules.git</code></li>
</ol>


<h1>The Docker Images</h1>

<p>We need to build the WSO2 IS Docker image first. For this we can take a long method of configuring the IS instance manually and then creating the Docker image with that pack or we can just save some time and let Puppet do the work. The Dockerfiles in the <a href="https://github.com/wso2/kubernetes-artifacts">WSO2 Kubernetes Artifacts repository</a> make use of <a href="https://github.com/wso2/puppet-modules">WSO2 Puppet Modules</a> to configure the server inside the Docker image.</p>

<h2>WSO2 Puppet Modules</h2>

<p>Navigate to where you checked out <a href="https://github.com/wso2/puppet-modules">WSO2 Puppet Modules</a> and build (<code>mvn clean install</code>) to get the latest WSO2 Puppet modules distribution, inside <code>target</code> folder. You can alternatively get the latest released distribution from the releases page on the <a href="https://github.com/wso2/puppet-modules/releases">GitHub repository</a>.</p>

<p>Now unzip the distribution to a place you prefer (Let&rsquo;s call this <code>&lt;PUPPET_HOME&gt;</code> here after). It&rsquo;s targeted to be unzipped directly to a Puppet Master folder (<code>/etc/puppet/</code>), so the structure of the decompressed folder looks similar to that of the inside of the Puppet Master folder.</p>

<p>WSO2 Puppet Modules heavily make use of <a href="https://docs.puppetlabs.com/hiera/1/">Hiera</a> to separate data and templates from the actual Puppet logic of configuration of the server. Therefore, the only modification that has to be done, has to be done to the Hiera YAML files and optionally the templates.</p>

<h3>Clustering</h3>

<p>Let&rsquo;s first change the clustering related data in Hiera. For this an understanding on how clustering for WSO2 products on Kubernetes is needed.</p>

<p>The Kubernetes Membership Scheme for Carbon makes use of the Kubernetes API to lookup the IP addresses of the Pods that are already up for given Kubernetes Service. For an example, for WSO2 IS, provided that the Kubernetes Service for WSO2 IS is <code>wso2is</code>, the Kubernetes Membership Scheme will make an API call to the Kubernetes API Server to find out the IP addresses of the Pods that are running. It will then update the Hazelcast instance with this list of IPs and connect to those members. When new members start, the process repeats, and the existing members get notified of its existence via Hazelcast. This membership scheme is pluggable to Hazelcast starting from Carbon 4.4.1.</p>

<p>With this understanding, lets make the changes required to enable Kubernetes Membership Scheme in WSO2 IS.</p>

<ol>
<li>Navigate to <code>&lt;PUPPET_HOME&gt;/hieradata/dev/wso2/wso2is/5.1.0/</code> and open <code>default.yaml</code> with your text editor.</li>
<li>Under <code>wso2::clustering</code> remove the <code>wka</code> related data and add the Kubernetes Membership Scheme data. The resulting section look something like the following.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">wso2::clustering</span> <span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">enabled</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span><span class='line'>    <span class="c1">#local_member_host : 127.0.0.1</span>
</span><span class='line'>    <span class="c1">#local_member_port : 4000</span>
</span><span class='line'>    <span class="l-Scalar-Plain">membership_scheme</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kubernetes</span>
</span><span class='line'>    <span class="c1">#wka :</span>
</span><span class='line'>    <span class="c1"># members :</span>
</span><span class='line'>    <span class="c1">#-</span>
</span><span class='line'>    <span class="c1">#hostname : localhost</span>
</span><span class='line'>    <span class="c1">#      port : 4000</span>
</span><span class='line'>    <span class="c1">#    -</span>
</span><span class='line'>    <span class="c1">#      hostname : localhost</span>
</span><span class='line'>    <span class="c1">#      port : 4001</span>
</span><span class='line'>    <span class="c1">#multicast :</span>
</span><span class='line'>    <span class="c1">#  domain : wso2.carbon.domain</span>
</span><span class='line'>    <span class="l-Scalar-Plain">k8</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">k8_master</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://172.17.8.101:8080</span>
</span><span class='line'>        <span class="l-Scalar-Plain">k8_namespace</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">default</span>
</span><span class='line'>        <span class="l-Scalar-Plain">k8_services</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that <code>http://172.17.8.101:8080</code> is the Kubernetes API Server address. Furthermore, note that the value for <code>k8_services</code> reflects the Kubernetes Service name we are going to use later.</p>

<ol>
<li><p>We also need to add the Kubernetes Membership Scheme distribution to the <code>&lt;WSO2_SERVER_HOME&gt;/repository/components/lib</code> folder along with its dependencies. So let&rsquo;s first build the Kubernetes Membership Scheme. Navigate to where you checked out <a href="https://github.com/wso2/kubernetes-artifacts">WSO2 Kubernetes Artifacts repository</a> and to the <code>common/kubernetes-membership-scheme</code> folder inside. Build the Kubernetes Membership Scheme by running <code>mvn clean install</code>. Copy the resulting JAR file to <code>&lt;PUPPET_HOME&gt;/modules/wso2is/files/configs/repository/components/lib</code> folder. Furthermore copy the following dependencies to the same place as well.</p>

<ul>
<li><a href="http://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core/2.5.4">jackson-core-2.5.4.jar</a></li>
<li><a href="http://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind/2.5.4">jackson-databind-2.5.4.jar</a></li>
<li><a href="http://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-annotations/2.5.4">jackson-annotations-2.5.4.jar</a></li>
</ul>
</li>
<li><p>Now let&rsquo;s specify these files inside the <code>default.yaml</code> file, so Puppet would copy them to the respective places. Add the following entry to <code>default.yaml</code>.</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">wso2::file_list</span> <span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">repository/components/lib/jackson-annotations-2.5.4.jar</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">repository/components/lib/jackson-core-2.5.4.jar</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">repository/components/lib/jackson-databind-2.5.4.jar</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">repository/components/lib/kubernetes-membership-scheme-1.0.0-SNAPSHOT.jar</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Copying the Packs</h3>

<ol>
<li>Download <a href="http://wso2.com/products/identity-server/">WSO2 IS 5.1.0</a> and copy it to <code>&lt;PUPPET_HOME&gt;/modules/wso2is/files/</code> folder.</li>
<li>Download <a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html">JDK 1.7_80</a> and copy to <code>&lt;PUPPET_HOME&gt;/modules/wso2base/files/</code> folder.</li>
</ol>


<h2>Building the Docker image</h2>

<p>Navigate to where you checked out <a href="https://github.com/wso2/kubernetes-artifacts">WSO2 Kubernetes Artifacts repository</a>. We will be working inside this directory now.</p>

<h3>Base Image</h3>

<p>Docker images for WSO2 products make use of a base image called <code>wso2/k8s-base</code> which has to be built (or pulled from Docker Hub) before building the product images.</p>

<ol>
<li>List the Docker images in your machine.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker images
</span></code></pre></td></tr></table></div></figure>


<p>If the list doesn&rsquo;t contain <code>wso2/k8s-base</code> Docker image you have to build it first.</p>

<ol>
<li>Navigate to <code>common/docker/base-image</code> folder, and start the Docker image build by executing <code>build.sh</code>.</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./build.sh 1.0.0
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Wait until the Docker build process completes and verify after by listing the Docker images (<code>docker images</code>) to check <code>wso2/k8s-base</code> is there.</li>
</ol>


<h3>WSO2 IS Image</h3>

<p>Navigate to <code>wso2is/docker/</code> folder. Inside you will see the Dockerfile and some Bash scripts which will make your life so much easier when it comes to building and rebuilding Docker images for test purposes.</p>

<p>The <code>build.sh</code> builder script will be looking for the <code>PUPPET_HOME</code> environment variable. So before running <code>build.sh</code> point <code>PUPPET_HOME</code> to our Puppet home. Then run the <code>build.sh</code> file by providing the Docker image version to be built and the WSO2 Carbon profiles that should be built for this product. For WSO2 IS, there is only one Carbon profile, the <code>default</code> profile. So our commands will look like something as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">PUPPET_HOME</span><span class="o">=</span>~/temp/puppet
</span><span class='line'>./build.sh 1.0.0 <span class="s1">&#39;default&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Use sudo when executing <code>build.sh</code> if your Docker daemon needs privileged access. Here the place where we unzipped our WSO2 Puppet distribution (and modified Hiera data accordingly) is <code>~/temp/puppet</code>, and we need our Docker image to be tagged as version <code>1.0.0</code>, and we only need to build the Docker image for the <code>default</code> Carbon profile for WSO2 IS. Specifying only <code>default</code> is optional.</p>

<p>This will build the Docker image by configuring WSO2 IS using the <code>PUPPET_HOME</code> folder, and including the necessary <code>ENTRPOINT</code> scripts. List your docker images afterwards (<code>docker images</code>) and you will see something similar to the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>REPOSITORY               TAG                   IMAGE ID            CREATED             VIRTUAL SIZE
</span><span class='line'>wso2/is-5.1.0            1.0.0                 c8ab0b692142        19 hours ago        1.45 GB
</span><span class='line'>wso2/k8s-base            1.0.0                 2216147d6c98        22 hours ago        310.6 MB
</span></code></pre></td></tr></table></div></figure>


<p>Next we deploy our Docker images on Kubernetes.</p>

<h1>Kubernetes Setup</h1>

<p>It would greatly help if you already have a Kubernetes cluster deployed somewhere nearby. However, it&rsquo;s safe to assume you&rsquo;re reading this just to try out this work flow, and you don&rsquo;t have a Kubernetes Cluster. In that case there are several easy options you can chose from.</p>

<h2>Kubernetes Vagrant Setup</h2>

<p><a href="http://kubernetes.io/v1.1/docs/getting-started-guides/vagrant.html">Kubernetes ships with its own Vagrantfile</a> which can make use of several Virtualization providers to quickly create a Kubernetes Cluster. You will be able to use VirtualBox as the provider and spawn a new Kubernetes cluster with one or more Nodes (previously <code>Minions</code>). However my personal experience with this has not been pleasant, because of the time it takes for the nodes to provision (SaltStack is used to provision the Fedora based nodes) and the issues it had when recreating the Cluster.</p>

<h2>github.com/pires/kubernetes-vagrant-coreos-cluster</h2>

<p><a href="https://github.com/pires/kubernetes-vagrant-coreos-cluster">This</a> is a similar setup as the above, but with several differences. First off, it uses CoreOS boxes for the Master and Node VMs. Second, it&rsquo;s really easy to destroy and recreate a cluster, in case you feel like Stalin. I keep the following short run script to start the cluster.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nb">export </span><span class="nv">NODES</span><span class="o">=</span>1
</span><span class='line'><span class="nb">export </span><span class="nv">USE_KUBE_UI</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'>
</span><span class='line'>vagrant up
</span></code></pre></td></tr></table></div></figure>


<p>This starts a Kubernetes Cluster with one Master and one Node VM, with IPs 172.17.8.101 and 172.17.8.102 each respectively.</p>

<h2>Any Other Options?</h2>

<p>Well, I can copy paste the Kubernetes documentation here, or you can simply <a href="http://kubernetes.io/v1.1/docs/getting-started-guides/README.html">go there and read</a> the other options you have, which tend to demand a little bit of commitment. So if you&rsquo;re afraid of that better stick to the Vagrant setups above.</p>

<h1>WSO2 IS Cluster</h1>

<p>We built the Docker images, and now we have a Kubernetes Cluster. The next logical step is to go ahead and deploy the Docker image on top of the Kubernetes Cluster. To do that we need to do the following.</p>

<ol>
<li>Either upload the WSO2 IS Docker image to an accessible Docker registry or load it to the Nodes&#8217; Docker registry (If you created a Vagrant setup for Kubernetes, the easier option would be to compress the WSO2 IS Docker image to a tar file, scp it to the Node/s and Load the tar to the local Docker registry)</li>
<li>Deploy a Replication Controller for WSO2 IS Docker image, with a replica count.</li>
<li>Deploy a Kubernetes Service for the WSO2 IS Pods</li>
<li>???</li>
<li>Profit</li>
</ol>


<h2>Load Docker image</h2>

<p>Let&rsquo;s load our Docker image to the Node/s. You can run the <code>save.sh</code> file inside <code>wso2is/docker/</code> folder. It will save the Docker image to <code>~/docker/images/</code> folder as <code>.tar</code> file. Or you can simply call <code>docker save</code> and create the <code>.tar</code> file yourself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker save wso2/is-5.1.0:1.0.0 &gt; wso2is-5.1.0-1.0.0.tar
</span><span class='line'><span class="c">#insecure_private_key is the key to use to ssh inside the Vagrant boxes, 172.17.8.102 is the Node&#39;s IP</span>
</span><span class='line'>scp -i ~/.vagrant.d/insecure_private_key wso2is-5.1.0-1.0.0.tar core@172.17.8.102:.
</span><span class='line'><span class="c"># ssh to the node and load the Docker image</span>
</span><span class='line'>vagrant ssh node-01
</span><span class='line'>docker load &lt; wso2is-5.1.0-1.0.0.tar
</span><span class='line'>docker images <span class="c"># to verify the image was loaded successfully</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Replication Controller</h2>

<p>A Replication Controller makes sure that a specified number of Pods will always be there in the Cluster. We specify the Docker image to use, the number of replicas to maintain, and the labels that should be applied to the Pods. You can find the Replication Controller for WSO2 IS in <code>wso2is/kubernetes/wso2is-controller.yaml</code>. It looks something like the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ReplicationController</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'>  <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">replicas</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'>  <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'>    <span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">containers</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'>        <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2/is-5.1.0:1.0.0</span>
</span><span class='line'>        <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span>
</span><span class='line'>          <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9763</span>
</span><span class='line'>          <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="s">&quot;TCP&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span>
</span><span class='line'>          <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9443</span>
</span><span class='line'>          <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="s">&quot;TCP&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span>
</span><span class='line'>          <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000</span>
</span><span class='line'>          <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="s">&quot;TCP&quot;</span>
</span><span class='line'>        <span class="p-Indicator">-</span>
</span><span class='line'>          <span class="l-Scalar-Plain">containerPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10500</span>
</span><span class='line'>          <span class="l-Scalar-Plain">protocol</span><span class="p-Indicator">:</span> <span class="s">&quot;TCP&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, we have specified the image to use as <code>wso2/is-5.1.0:1.0.0</code>. If you built your image with a different name, change this value. Also, we have specified the number of replicas to be just one.</p>

<p>Let&rsquo;s deploy the Replication Controller. (If you used the Vagrant Setup, you can directly use the <code>deploy.sh</code> script included along with the Replication Controller in the same folder. It will also deploy the Service artifact and wait until the WSO2 IS server to come up, so for the purpose of understanding the process, let&rsquo;s manually deploy the artifacts separately.)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl create -f wso2is-controller.yaml
</span></code></pre></td></tr></table></div></figure>


<p>If you get an error like the following, it means that kubectl cannot find the Kubernetes API Server to communicate with it. So you have to point out where the API Server is to the kubectl.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl create -f wso2is-controller.yaml
</span><span class='line'>error: couldn<span class="err">&#39;</span>t <span class="nb">read </span>version from server: Get http://localhost:8080/api: dial tcp 127.0.0.1:8080: connection refused
</span><span class='line'><span class="nb">export </span><span class="nv">KUBERNETES_MASTER</span><span class="o">=</span>http://172.17.8.101:8080 <span class="c">#If your Kubernetes Master IP and Port is different, change this accordingly</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the other hand if your system simply doesn&rsquo;t have kubectl installed, you first need to <a href="http://kubernetes.io/v1.1/docs/user-guide/prereqs.html">install it</a>.</p>

<p>If everything went right Kubernetes will spawn a Pod with a WSO2 IS container inside it, in one of the Nodes. You can get the list of Pods deployed by issueing <code>kubectl get pods</code>.</p>

<h2>Kubernetes Service</h2>

<p>To expose the WSO2 IS container from Kubernetes, we need to define a Service which maps the operational ports of the WSO2 IS container with ports on the Nodes. For this we need to specify a selector for the Pods that should be served through the Service and the port mapping. You can find the following Service definition in <code>wso2is/kubernetes/wso2is-service.yaml</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">apiVersion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">v1</span>
</span><span class='line'><span class="l-Scalar-Plain">kind</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Service</span>
</span><span class='line'><span class="l-Scalar-Plain">metadata</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">labels</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'>  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span><span class='line'><span class="l-Scalar-Plain">spec</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">NodePort</span>
</span><span class='line'>  <span class="l-Scalar-Plain">sessionAffinity</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ClientIP</span>
</span><span class='line'>  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="c1"># ports that this service should serve on</span>
</span><span class='line'>    <span class="p-Indicator">-</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;servlet-http&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9763</span>
</span><span class='line'>      <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9763</span>
</span><span class='line'>      <span class="l-Scalar-Plain">nodePort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">32001</span>
</span><span class='line'>    <span class="p-Indicator">-</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;servlet-https&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9443</span>
</span><span class='line'>      <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9443</span>
</span><span class='line'>      <span class="l-Scalar-Plain">nodePort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">32002</span>
</span><span class='line'>    <span class="p-Indicator">-</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;kdc-server&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000</span>
</span><span class='line'>      <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">8000</span>
</span><span class='line'>      <span class="l-Scalar-Plain">nodePort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">32003</span>
</span><span class='line'>    <span class="p-Indicator">-</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&#39;thrift-entitlement&#39;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10500</span>
</span><span class='line'>      <span class="l-Scalar-Plain">targetPort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">10500</span>
</span><span class='line'>      <span class="l-Scalar-Plain">nodePort</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">32004</span>
</span><span class='line'>  <span class="c1"># label keys and values that must match in order to receive traffic for this service</span>
</span><span class='line'>  <span class="l-Scalar-Plain">selector</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wso2is</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this service we have exposed port 9443 of the WSO2 IS container through the port 32002 on the Node. Since the type of the Service is <code>NodePort</code>, the port 32002 on all of the Nodes will be mapped to the port 9443 of the container. Another interesting thing to note is that we have specified <code>metadata:name</code> as <code>wso2is</code> which is the same name we provided for <code>k8_services</code> when we configured the Kubernetes Membership Scheme earlier.</p>

<p>Let&rsquo;s deploy this Service.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>kubectl create -f wso2is-service.yaml
</span><span class='line'>kubectl get svc
</span></code></pre></td></tr></table></div></figure>


<h1>Accessing WSO2 IS</h1>

<p>Now we have a WSO2 IS container Cluster on Kubernetes. How are we going to access it? Simple. We just access any Node on the port 32002 to access the Carbon Console. For example, in the Vagrant Setup, we can access the Carbon console by going to <code>https://172.17.8.102:32002/carbon</code>. You can read more about the <a href="http://kubernetes.io/v1.1/docs/user-guide/services.html#type-nodeport">NodePort</a> type Services to understand what is happening here.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/10/breadpool-a-thread-pool-for-python/">BreadPool - a Thread Pool for Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-10T19:54:09+05:30" pubdate data-updated="true">Dec 10<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/breadpool/'>breadpool</a> <a class='category label label-primary' href='/blog/categories/library/'>library</a> <a class='category label label-primary' href='/blog/categories/multithreading/'>multithreading</a> <a class='category label label-primary' href='/blog/categories/python/'>python</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>A thread pool is not a new concept. It&rsquo;s basically a gang of worker threads to whom a task would be given to be executed. Why thread pools? Because the program wouldn&rsquo;t be starting threads as it sees fit and somehow reach the maximum thread number soon. Simply said thread pools allows us to limit the number of threads spawned by our program execution. Trust me, you don&rsquo;t want your code going to town spawning threads. It comes back to bite you in your behind, sooner than you think.</p>

<p>Programming languages usually provide built in libraries implementing thread pools, however Python doesn&rsquo;t seem to have a pooling strategy for threads. It does however have a <a href="https://pymotw.com/2/multiprocessing/communication.html#process-pools">Process Pool</a> concept, where a set of workers can be used to submit a function, but that involves more complexities (ex: function&rsquo;s ability to be pickled or unpickled) than threads. It also involves processes, which differ drastically from threads when it comes to multi-threading requirements.</p>

<p>However it&rsquo;s considerably easier in Python to write a simple thread pool implementation. All we really need is a thread safe blocking queue, a task interface, and a thread implementation which waits for tasks to appear on the blocking task queue. That is exactly why I decided to pack that all in to a single Python library called <a href="https://github.com/chamilad/breadpool">BreadPool</a>.</p>

<p>In the past there were several instances where, for me, the need for a proper thread pool implementation came up without the time to dedicate write one from scratch. This would result in several thread pool implementations everywhere. It&rsquo;s better to have a thread pool implementation at a mere <code>pip install</code>.</p>

<p>BreadPool can be installed from PyPI and used immediately.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip install breadpool
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">breadpool.pool</span> <span class="kn">import</span> <span class="n">ThreadPool</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">thread_pool</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;CustomThreadPool&quot;</span><span class="p">,</span> <span class="n">polling_timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will make sure that we will have a set of worker threads numbering no more than 5. You can refer more documentation on the project <a href="https://github.com/chamilad/breadpool">GitHub&rsquo;s README</a>.</p>

<p>BreadPool also includes a scheduled task executor which would submit a given task to a given thread pool, repeatedly with a given time interval in between. It&rsquo;s supposed to be a thread safe way to schedule a certain task without rewriting your own scheduled executor for Python 2.7. It&rsquo;s designed with Java&rsquo;s ScheduledExecutor in mind, but still has a few more features to be desired.</p>

<p>BreadPool doesn&rsquo;t depend on anything other than the Python 2.7 standard library, and will try to keep it that way in the future. So it doesn&rsquo;t drag anything unexpected in.</p>

<p>The released version is <a href="https://pypi.python.org/pypi/breadpool/0.0.5">0.0.5</a>, and is licensed under Apache v2.0. Feel free to download and use BreadPool. The code base is small, and the work was short, but I figured it would save some time for you when it comes to worrying about thread pools.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/26/timing-out-of-long-running-methods-in-python/">Timing Out of Long Running Methods in Python</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-26T22:26:03+05:30" pubdate data-updated="true">Nov 26<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/python/'>python</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes there are conditions under which a function call could not return in a needed time period and would cause unexpected behavior. For example, a file read could take more time than anticipated and leave the code execution without proper control over what to do when such a situation occurs. This can be worse if the said function call directs to an external library which we can&rsquo;t control.</p>

<p>Python has a nifty module called <code>signal</code> which exposes <a href="https://en.wikipedia.org/wiki/Unix_signal#POSIX_signals">UNIX Signal</a> numbers and a way to register callbacks for each signal. Out of the UNIX Signals available, what interests us in this particular situation is the <a href="http://linux.die.net/man/2/alarm">SIGALRM</a> signal which allows us to sort of wind out an OS level alarm clock that would send a signal to the calling process after the set number of seconds. We can make use of this functionality (only in UNIX of course) to set a timeout before a function call with the possibility to hang or take unexpected durations to finish.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">signal</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">timeout_handler</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Received SIGALRM&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;FUBAR&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">long_function</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;LEEEEROYYY JENKINSSSSS!!!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
</span><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Before: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%M:%S&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">long_function</span><span class="p">()</span>
</span><span class='line'><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&quot;FUBAR&quot;</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Gotcha!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;We&#39;re gonna need a bigger boat!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">finally</span><span class="p">:</span>
</span><span class='line'>    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;After: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%M:%S&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you run this Python code, you will see an output similar to the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Before</span><span class="p">:</span> <span class="mi">22</span><span class="p">:</span><span class="mi">10</span>
</span><span class='line'><span class="n">LEEEEROYYY</span> <span class="n">JENKINSSSSS</span><span class="err">!!!</span>
</span><span class='line'><span class="n">Received</span> <span class="n">SIGALRM</span>
</span><span class='line'><span class="n">Gotcha</span><span class="err">!</span>
</span><span class='line'><span class="n">After</span><span class="p">:</span> <span class="mi">22</span><span class="p">:</span><span class="mi">20</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let us take a walk through the code.</p>

<p>First let&rsquo;s look at the supposedly long running function. What this does is to simply wait for 60 seconds before continuing. This is to emulate a blocked file read, or a hung server connection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">long_function</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;LEEEEROYYY JENKINSSSSS!!!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to tell the <code>signal</code> module to execute our own function when <code>SIGALRM</code> signal is received by the process. So let&rsquo;s first write a handler function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">timeout_handler</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Received SIGALRM&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;FUBAR&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Notice that in the <code>timeout_handler</code> function we are raising an exception. This is to make our decision making process a bit easier. More on that later. Now let&rsquo;s register this with the <code>SIGALRM</code> signal.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now when this Python process receives a <code>SIGALRM</code> signal, it will execute the <code>timeout_handler</code> function.</p>

<p><code>signal.alarm(10)</code> tells the OS to send a <code>SIGALRM</code> after 10 seconds from this point onwards. After setting the alarm clock we invoke the long running function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Before: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%M:%S&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">long_function</span><span class="p">()</span>
</span><span class='line'><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&quot;FUBAR&quot;</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Gotcha!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;We&#39;re gonna need a bigger boat!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">finally</span><span class="p">:</span>
</span><span class='line'>    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;After: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%M:%S&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>10 seconds after invoking the <code>long_function</code>, the execution will be interrupted and <code>timeout_handler</code> function will raise the exception <code>FUBAR</code>. We are catching that at line 6 and based on that we can make a decision on what to do since our function with a possibility to hang has in fact seems to be hung and did not terminate in a healthy or unhealthy manner.</p>

<p>Notice that we set the alarm to 0 seconds after all is done. That is to do one thing, cancel the previously set alarm (although in our case it <a href="https://media.giphy.com/media/Vuw9m5wXviFIQ/giphy.gif">doesn&rsquo;t even matter</a>).</p>

<p>If we check the output of this program again, you will see that we received the <code>SIGALRM</code> exactly after 10 seconds.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Before</span><span class="p">:</span> <span class="mi">22</span><span class="p">:</span><span class="mi">10</span>
</span><span class='line'><span class="n">LEEEEROYYY</span> <span class="n">JENKINSSSSS</span><span class="err">!!!</span>
</span><span class='line'><span class="n">Received</span> <span class="n">SIGALRM</span>
</span><span class='line'><span class="n">Gotcha</span><span class="err">!</span>
</span><span class='line'><span class="n">After</span><span class="p">:</span> <span class="mi">22</span><span class="p">:</span><span class="mi">20</span>
</span></code></pre></td></tr></table></div></figure>


<p>Clear as a bell right?</p>

<p>Let&rsquo;s do some tweaking. Let&rsquo;s not set the OS alarm clock. Let&rsquo;s send the signal ourselves.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">signal</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">timeout_handler</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Received SIGALRM [</span><span class="si">%s</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
</span><span class='line'>    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;FUBAR&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">long_function</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;LEEEEROYYY JENKINSSSSS!!!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;PID: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
</span><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
</span><span class='line'><span class="c"># signal.alarm(10)</span>
</span><span class='line'>
</span><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Before: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%M:%S&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">long_function</span><span class="p">()</span>
</span><span class='line'><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="s">&quot;FUBAR&quot;</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Gotcha!&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;We&#39;re gonna need a bigger boat!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot;After: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%M:%S&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have commented out the alarm clock setting in line 15 and in line 13 we have printed out the process ID of the Python process. We are going to send the <code>SIGALRM</code> signal using the <code>kill</code> command to that process ID.</p>

<p>Open two terminals and run the above script in one terminal. Note the process ID and in the other terminal execute the following command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">kill</span> -14 <span class="o">{</span>pid<span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>14</code> is the integer number of the <code>SIGALRM</code> signal. Notice that the time duration between the start of the <code>long_function</code> call and the <code>FUBAR</code> exception differs based on the time we take to send the <code>SIGALRM</code> signal.</p>

<p>One important fact to note when using <code>signal</code> module is that it doesn&rsquo;t work well in a multi-threaded flow. The callback has to be registered in main thread, and the alarm will also be received by the main thread. So if you&rsquo;re trying to match <code>signal</code> and <code>threading</code> modules together you&rsquo;ll frequently see the following exception being raised.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>signal only works in main thread
</span></code></pre></td></tr></table></div></figure>


<p>Better thread down, or thread up and use a <code>Queue</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/17/creating-a-simple-activemq-master-slash-slave-setup/">Creating a Simple ActiveMQ Master/Slave Setup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-17T17:11:12+05:30" pubdate data-updated="true">Nov 17<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-activemq/'>apache activemq</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>ActiveMQ is a high performing message broker, however if clustering is needed, it supports <a href="http://activemq.apache.org/clustering.html">a number of methods</a>. Out of these, the <a href="http://activemq.apache.org/masterslave.html">Master/Slave</a> is a pattern where the persistence layer is shared between multiple broker instances. A Single <code>Master</code> broker connects to the persistence, and the rest of the <code>Slave</code> brokers keep waiting to attain the lock on the persistence. If the Master node goes down the lock for the persistence is released and a Slave quickly acquires it, allowing a client to continue operation without any data loss. The clients should connect to the Master/Slave setup, using the <code>failover:</code> transport, or they should implement a manual failover mechanism to automatically connect to the next available broker when the first one goes down.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">connectionfactoryName</span><span class="o">=</span><span class="s">TopicConnectionFactory</span>
</span><span class='line'><span class="na">java.naming.provider.url</span><span class="o">=</span><span class="s">failover:(tcp://localhost:61617,tcp://localhost:61618,tcp://localhost:61619)?initialReconnectDelay=100</span>
</span><span class='line'><span class="na">java.naming.factory.initial</span><span class="o">=</span><span class="s">org.apache.activemq.jndi.ActiveMQInitialContextFactory</span>
</span></code></pre></td></tr></table></div></figure>


<h1>How to Setup a Master/Slave</h1>

<p>Let&rsquo;s setup two broker instances in the same machine. The two instances will open different ports for the protocols, so there will be no conflicts. They will use the flat file based embedded KahaDB as the persistence layer and the two instances will share the KahaDB instance.</p>

<h2>Creating Two Broker Instances</h2>

<p>Unzip the ActiveMQ distribution to two places and offset port values in the second one to use different ports so that there will be no conflicts for ports used by the different protocol connectors. The places to change are in <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code> and <code>&lt;ACTIVEMQ_HOME&gt;/conf/jetty.xml</code>.</p>

<figure class='code'><figcaption><span>activemq.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;transportConnectors&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;openwire&quot;</span> <span class="na">uri=</span><span class="s">&quot;tcp://0.0.0.0:61626?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;amqp&quot;</span> <span class="na">uri=</span><span class="s">&quot;amqp://0.0.0.0:5682?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;stomp&quot;</span> <span class="na">uri=</span><span class="s">&quot;stomp://0.0.0.0:61623?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;mqtt&quot;</span> <span class="na">uri=</span><span class="s">&quot;mqtt://0.0.0.0:1893?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;ws&quot;</span> <span class="na">uri=</span><span class="s">&quot;ws://0.0.0.0:61624?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/transportConnectors&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>jetty.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jettyPort&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.activemq.web.WebConsolePort&quot;</span> <span class="na">init-method=</span><span class="s">&quot;start&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- the default port number for the web console --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;host&quot;</span> <span class="na">value=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;port&quot;</span> <span class="na">value=</span><span class="s">&quot;8171&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s point the KahaDB persistence to the same location. This will result in only one instance at a time being able to acquire the lock to the DB and when the lock is released the other instance will be able get it from the same location.</p>

<p>Modify the <code>persistenceAdapter</code> tag inside <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code> as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;persistenceAdapter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;kahaDB</span> <span class="na">directory=</span><span class="s">&quot;/tmp/mq/kahadb&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/persistenceAdapter&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do this change for both of the instances.</p>

<p>Now, let&rsquo;s introduce the two instances to each other by adding a <code>networkConnector</code> pointing to each other. Add the following block to the <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code> after the <code>persistenceAdapter</code> block in the master.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;networkConnectors&gt;</span>
</span><span class='line'>    <span class="nt">&lt;networkConnector</span> <span class="na">uri=</span><span class="s">&quot;static:(tcp://localhost:61626)&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/networkConnectors&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Port <code>61626</code> is the OpenWire port in the Slave instance. Similarly add the same block in the Slave <code>activemq.xml</code> file, pointing to the Master&rsquo;s OpenWire port. Static discovery is used here to statically point to the existing broker instances.</p>

<h2>Starting the instances</h2>

<p>Now let&rsquo;s start the Master broker instance.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> &lt;ACTIVEMQ_HOME&gt;/bin
</span><span class='line'>./activemq start
</span><span class='line'><span class="c"># tail the logs just for the fun of it</span>
</span><span class='line'>tail -100f ../data/activemq.log
</span></code></pre></td></tr></table></div></figure>


<p>When observing the logs you will see some log entries similar to the following repeatedly appearing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2015-11-17 19:10:19,731 <span class="p">|</span> INFO  <span class="p">|</span> Establishing network connection from vm://localhost?async<span class="o">=</span><span class="nb">false</span><span class="p">&amp;</span><span class="nv">network</span><span class="o">=</span><span class="nb">true </span>to tcp://localhost:61626 <span class="p">|</span> org.apache.activemq.network.DiscoveryNetworkConnector <span class="p">|</span> ActiveMQ Task-61
</span><span class='line'>2015-11-17 19:10:19,733 <span class="p">|</span> INFO  <span class="p">|</span> Connector vm://localhost started <span class="p">|</span> org.apache.activemq.broker.TransportConnector <span class="p">|</span> ActiveMQ Task-61
</span><span class='line'>2015-11-17 19:10:19,736 <span class="p">|</span> INFO  <span class="p">|</span> localhost Shutting down <span class="p">|</span> org.apache.activemq.network.DemandForwardingBridgeSupport <span class="p">|</span> ActiveMQ BrokerService<span class="o">[</span>localhost<span class="o">]</span> Task-134
</span><span class='line'>2015-11-17 19:10:19,738 <span class="p">|</span> INFO  <span class="p">|</span> localhost bridge to Unknown stopped <span class="p">|</span> org.apache.activemq.network.DemandForwardingBridgeSupport <span class="p">|</span> ActiveMQ BrokerService<span class="o">[</span>localhost<span class="o">]</span> Task-134
</span><span class='line'>2015-11-17 19:10:19,739 <span class="p">|</span> INFO  <span class="p">|</span> Connector vm://localhost stopped <span class="p">|</span> org.apache.activemq.broker.TransportConnector <span class="p">|</span> ActiveMQ Task-61
</span><span class='line'>2015-11-17 19:10:19,741 <span class="p">|</span> WARN  <span class="p">|</span> Could not start network bridge between: vm://localhost?async<span class="o">=</span><span class="nb">false</span><span class="p">&amp;</span><span class="nv">network</span><span class="o">=</span><span class="nb">true </span>and: tcp://localhost:61626 due to: Connection refused <span class="p">|</span> org.apache.activemq.network.DiscoveryNetworkConnector <span class="p">|</span> ActiveMQ Task-61
</span></code></pre></td></tr></table></div></figure>


<p>This is because we &ldquo;introduced&rdquo; the Slave broker to the Master broker and now it&rsquo;s looking for it.</p>

<p>Now start the Slave broker and tail the logs. You will see a different set of logs appearing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2015-11-17 18:34:37,359 <span class="p">|</span> INFO  <span class="p">|</span> Database /tmp/mq/kahadb/lock is locked... waiting 10 seconds <span class="k">for </span>the database to be unlocked. Reason: java.io.IOException: File <span class="s1">&#39;/tmp/mq/kahadb/lock&#39;</span> could not be locked. <span class="p">|</span> org.apache.activemq.store.SharedFileLocker <span class="p">|</span> main
</span></code></pre></td></tr></table></div></figure>


<p>This is because the lock for the shared DB is already acquired by the Master broker. The Slave broker will not start until it is able to acquire the lock for the DB. If you try to see which ports are open using the <code>netstat</code> command you will see that only the Master broker is up and running and ready to accept requests.</p>

<p>Now if you connect to the broker setup using the <code>failover:</code> transport you will see that the client connected the Master broker. Create a queue and publish an event to the queue without consuming it. Now stop the Master broker. You will see the Slave broker acquiring the lock to the DB and become ready to accept requests. Start a consumer with the <code>failover</code> transport and observe it connecting to and retrieving the event (which was published to the Master broker) from the Slave broker. There was no data loss and the service didn&rsquo;t stop responding for more than a few moments which the Slave took to start up after acquiring the DB lock.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/16/support-for-activemq-master-slash-slave-failover-in-apache-stratos-cartridge-agent/">Support for ActiveMQ Master/Slave Failover in Apache Stratos Cartridge Agent</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-16T20:20:07+05:30" pubdate data-updated="true">Nov 16<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-activemq/'>apache activemq</a> <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>In Apache Stratos the message broker is a crucial point of operation upon which all components depend on. Recent Stratos releases included fixes to <a href="http://code.chamiladealwis.com/blog/2015/10/11/secure-message-broker-communication-in-apache-stratos/">secure the message broker communication</a>. The upcoming 4.1.5 release will contain a missing improvement for the Python Cartridge Agent related to message broker communication.</p>

<p>ActiveMQ supports <a href="http://activemq.apache.org/clustering.html">various types of clustering patterns</a>. Out of these, <a href="http://activemq.apache.org/masterslave.html">Master/Slave</a> is a deployment pattern where the message store is replicated or shared between the clustered brokers. This makes it possible for a client to failover from the <code>master</code> to the <code>slave</code> in case the master broker goes down, and continue the communication without any data loss.</p>

<p>Earlier, the Cartridge Agent implementation was in Java and the ActiveMQ client used in Apache Stratos allowed the failover transport to be used right out of the box, by using the <code>failover</code> transport in the JNDI configuration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">connectionfactoryName</span><span class="o">=</span><span class="s">TopicConnectionFactory</span>
</span><span class='line'><span class="na">java.naming.provider.url</span><span class="o">=</span><span class="s">failover:(tcp://localhost:61617,tcp://localhost:61618,tcp://localhost:61619)?initialReconnectDelay=100</span>
</span><span class='line'><span class="na">java.naming.factory.initial</span><span class="o">=</span><span class="s">org.apache.activemq.jndi.ActiveMQInitialContextFactory</span>
</span></code></pre></td></tr></table></div></figure>


<p>However when the Python implementation of the Cartridge Agent was done this support was not implemented initially. Therefore, it was only possible for Python Cartridge Agent to connect to only one given message broker making it a possible point of failure.</p>

<p>However the upcoming 4.1.5 release contains the fix for the Python Cartridge Agent which enables it to accept a list of message brokers. This is provided via the <code>agent.conf</code> configuration file as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="k">[agent]</span>
</span><span class='line'><span class="na">mb.urls</span>                               <span class="o">=</span><span class="s">localhost:1885,localhost:1886,localhost:1887</span>
</span><span class='line'><span class="na">mb.username</span>                           <span class="o">=</span><span class="s">system</span>
</span><span class='line'><span class="na">mb.password</span>                           <span class="o">=</span><span class="s">manager</span>
</span><span class='line'><span class="na">mb.publisher.timeout</span>                  <span class="o">=</span><span class="s">900</span>
</span></code></pre></td></tr></table></div></figure>


<p>The crucial change is from <code>mb.username</code> and <code>mb.password</code> to <code>mb.urls</code>. This will be a comma separated list of host:port values of the available broker list.</p>

<p>When communicating with the message broker, the Python Cartridge Agent will go through the provided URL list and connect to the first broker that is available.</p>

<p>The listening subscriber client will always make an effort to keep a connection to one of the brokers. i.e. if the connected broker goes down (the Python Cartridge Agent will periodically check if the connected message broker is in fact alive or not), it will go through the message broker list and select the first available broker. If none of the provided message brokers are online, the subscribing client will keep retrying until one broker becomes available. This logic will separately execute for each topic subscription.</p>

<p>The publishing client will publish the events to the first broker available. If none of the brokers are available it will keep retrying to publish the event, until the provided <code>mb.publisher.timeout</code> value is exceeded. The default value for this is 15 minutes. After that timeout, if the event is still unpublished, it will be dropped, and life moves on.</p>

<p>Notice that it will be possible for the events to be published to one broker and intended consumers to be connected to another. However, if the Master/Slave deployment is done correctly data sharing happens without an issue and this situation shouldn&rsquo;t be of any concern.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/11/secure-message-broker-communication-in-apache-stratos/">Secure Message Broker Communication in Apache Stratos With Apache ActiveMQ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-11T00:55:36+05:30" pubdate data-updated="true">Oct 11<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-activemq/'>apache activemq</a> <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>Apache Stratos relies heavily on message broker communication. In fact, message broker communication with message broker topics is the main method of communication between components such as the Cartridge Agent, Cloud Controller and the Autoscaler, as this allows a decoupled architecture for the components.</p>

<p><img src="/images/post_resource/stratos/ca-overview.png"></p>

<p>When it comes to message brokers, authentication is a crucial part of securing the communication channel since if left unsecured, anyone with access to the message broker can subscribe to the topics and listen to the communication between the components. This can expose sensitive data easily and the system would be compromised in no time. The purpose of this article is to explain how to engage Username and Password based authentication with Apache ActiveMQ in Stratos.</p>

<h1>Securing ActiveMQ</h1>

<p>ActiveMQ allows to add authentication and authorization through an extensible plugin system. For our purpose, the out of the box <code>SimpleAuthenticationPlugin</code> is more than enough as it allows us to define a username and a password with the list of user groups the particular user belongs to.</p>

<p>To engage <code>SimpleAuthenticationPlugin</code> we have to add the following section before the <code>broker</code> tag closes, in <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;plugins&gt;</span>
</span><span class='line'>    <span class="nt">&lt;simpleAuthenticationPlugin&gt;</span>
</span><span class='line'>        <span class="nt">&lt;users&gt;</span>
</span><span class='line'>            <span class="nt">&lt;authenticationUser</span> <span class="na">username=</span><span class="s">&quot;system&quot;</span> <span class="na">password=</span><span class="s">&quot;manager&quot;</span> <span class="na">groups=</span><span class="s">&quot;users,admins&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/users&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/simpleAuthenticationPlugin&gt;</span>
</span><span class='line'><span class="nt">&lt;/plugins&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see we have introduced a user named <code>system</code> with password <code>manager</code> who belongs to groups <code>users</code> and <code>admins</code>. Since we have not allowed anonymous access, any subscriber or a publisher that connects to ActiveMQ should provide these credentials to successfully communicate. We can enable anonymous access by specifying the <code>allowAnonymousAccess</code> attribute on <code>simpleAuthenticationPlugin</code> to <code>true</code>.</p>

<p>After the configuration file is saved, restart ActiveMQ.</p>

<h1>Providing Credentials on Stratos</h1>

<p>Within Stratos there are three configurations that we have to provide message broker credentials in to.</p>

<h2>Stratos Components &ndash; Cloud Controller, Autoscaler, Stratos Manager</h2>

<p>The ActiveMQ credentials for Stratos components can be provided by the <code>jndi.properties</code> file. Simply add the following two lines in the <code>&lt;STRATOS_HOME&gt;/repository/conf/jndi.properties</code> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>java.naming.security.principal=system
</span><span class='line'>java.naming.security.credentials=manager
</span></code></pre></td></tr></table></div></figure>


<p><code>java.naming.security.principal</code> corresponds to the ActiveMQ username and <code>java.naming.security.credentials</code> contains the password.</p>

<h2>Complex Event Processor</h2>

<p>Based on the health statistics published from the instances via <a href="http://code.chamiladealwis.com/blog/2014/10/10/thrift-communication-in-apache-stratos/">Thrift</a>, the Complex Event Processor publishes several crucial messages to the message broker. This is done using a JMSOutputAdaptor. To configure the JMSOutputAdaptor to use ActiveMQ credentials, add the following entries inside the <code>outputEventAdaptor</code> tag, in the configuration file at   <code>&lt;STRATOS_HOME&gt;/repository/deployment/server/outputeventadaptors/JMSOutputAdaptor.xml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;transport.jms.UserName&quot;</span><span class="nt">&gt;</span>system<span class="nt">&lt;/property&gt;</span>
</span><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;transport.jms.Password&quot;</span><span class="nt">&gt;</span>manager<span class="nt">&lt;/property&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Cartridge Agent</h2>

<p>The Python Cartridge Agent can be configured with ActiveMQ credentials by specifying the <code>mb.username</code> and <code>mb.password</code> options in the <code>agent.conf</code> file.</p>

<p>To do this in a Docker image managed by Kubernetes, specify the following options in the Kubernetes Cluster Configuration JSON file, under the <code>property</code> array.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;payload_parameter.MB_USERNAME&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span>
</span><span class='line'><span class="p">}</span><span class="err">,</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;payload_parameter.MB_PASSWORD&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;manager&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For a VM, these values can be specified in the <code>base.pp</code> manifest in the Puppet server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nv">$mb_username</span>          <span class="o">=</span> <span class="s1">&#39;system&#39;</span>
</span><span class='line'><span class="nv">$mb_password</span>          <span class="o">=</span> <span class="s1">&#39;manager&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After the credentials are enabled and configured, if anonymous access is not allowed, no external user without the credentials will not be able to listen to the communication or publish messages on the message broker.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/22/apache-stratos-cartridge-agent-life-cycle-walkthough/">Apache Stratos Cartridge Agent: Life Cycle Walkthough</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-22T17:48:56+05:30" pubdate data-updated="true">Mar 22<sup>nd</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Chamila de Alwis)" rel="author">Chamila de Alwis</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a> <a class='category label label-primary' href='/blog/categories/cartridge-agent/'>cartridge agent</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">first article</a>?</p></blockquote>

<p>The Cartridge Agent is (usually) the first service that starts in a spawned Cartridge instance. From that point onwards, it is responsible for keeping the relevant services running, communicating with Stratos to subscribe and publish to message broker topics, processing received events, artifact distribution and health statistics reporting. In this article we will discuss in detail, in which order these tasks are performed.</p>

<h1>Setup</h1>

<p>For our walkthrough let&rsquo;s take an application with a single PHP cartridge. The Puppet manifest for this PHP cartridge is distributed with Stratos source. The application will only consist of this cartridge. Following is the deployed application view of the Single PHP Cartridge Application.</p>

<p><img src="/images/post_resource/stratos/php-app-dep.png"></p>

<h2>Deploying the Application</h2>

<p>The sample scripts and artifacts for our scenario is available in the <code>samples</code> folder of the Stratos source. You can deploy this sample in any one of the available IaaS options including the Mock IaaS that is available in Stratos for developer testing purposes. Following is how it can be deployed in the Mock IaaS.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># navigate to the sample application folder</span>
</span><span class='line'><span class="nb">cd</span> &lt;STRATOS_SOURCE&gt;/samples/applications/single-cartridge/scripts/mock
</span><span class='line'><span class="c"># run deploy script</span>
</span><span class='line'>./deploy.sh
</span></code></pre></td></tr></table></div></figure>


<p>However the Mock IaaS does not involve the Cartridge Agent execution, and therefore is a bit irrelevant in our scenario. You can deploy the same application in OpenStack or Amazon EC2 to witness the Cartridge Agent execution. You can even use Docker on Kubernetes and deploy a Kubernetes cluster to deploy this Single PHP Cartridge application.</p>

<h2>What to Look For</h2>

<p>The steps that are explained here can be observed by looking at several sources. The Cartridge Agent logs and the Stratos log are the primary sources where published and received logs can be viewed. The Java Cartridge Agent logs are located in <code>/var/logs/apache-stratos/cartridge-agent.log</code> and the full Python Cartridge Agent logs can be located in the <code>/tmp/agent.screen.log</code>. The Python Cartridge Agent additionally has two other logs, <code>agent.log</code> which log the configured log level, <code>INFO</code> being the default, and the <code>error.log</code> which only log <code>ERROR</code> level logs. These two can be found in the Python Cartridge Agent home, by default in <code>/mnt/apache-stratos-python-cartridge-agent-4.1.0/</code>.</p>

<h2>Reference Image</h2>

<p>Most events that occur in a successful execution cycle of the Cartridge Agent is illustrated as a <a href="https://cwiki.apache.org/confluence/download/attachments/42567880/Cartridge%20Agent%20Lifecycle.png?api=v2">flow chart</a>. This does not include the failure scenarios and some multi-threaded executions are not properly illustrated, due to the limited nature of showing such details in a flow chart. However it is a good reference point to understand the Cartridge Agent life cycle in a sequential manner.</p>

<h1>Instance States</h1>

<p>An instance goes through a set of states during its life cylce. These states determine the behavior of the instance as well as other components in Stratos, when taking decisions about the instance. Following are the states that a spawned instance goes through during its life cycle.</p>

<ol>
<li>Created &ndash; Instance is created in the IaaS. But execution inside has not started.</li>
<li>Initialized &ndash; The execution of processes have started in the instance. Now the init scripts have started executing and Puppet agent would probably be running. Cartridge Agent will also start while being in this state.</li>
<li>Starting &ndash; The Cartridge Agent has published the InstanceStartedEvent for this instance</li>
<li>Active &ndash; The Cartridge Agent has published InstanceActivatedEvent. This indicates that the services in the cartridge instance are working and accepting requests. The instance can now be consumed.</li>
<li>Pending Termination &ndash; The instance is moved to a termination pending queue, where the graceful shutdown of the instance has been called for.</li>
<li>Obsolete &ndash; If the instance was in the Pending Termination state, then the Cartridge Agent has published InstanceReadyToShutdownEvent. An instance can also end up in the Obsolete state directly from Starting, or Initialized states because of various reasons. The instances in the obsolete queue will be terminated eventually.</li>
</ol>


<p>The state transitions can also be seen from the reference image. Additionally, you can understand how the member state transition happens from the Autoscaler side by going through <a href="http://lahiruwrites.blogspot.com/2015/03/stratos-410-deveper-guide-autoscaler.html">this</a> article written by Lahiru Sandaruwan.</p>

<p>With this knowledge at hand, let us dive in to the walkthrough right away.</p>

<h2>Created</h2>

<p>When the application is deployed after creating the Cluster Monitors for each cluster of Cartridges, Cloud Controller issues instance creation requests to the IaaS via JClouds. The instance state at the moment is <code>CREATED</code>.</p>

<h2>Initialized</h2>

<p>When the instance creation is complete, the IP addresses are assigned, and the instance starts execution, the status changes to <code>INITIALIZED</code>. The init scripts are executed and the Puppet agent downloads and applies the related Puppet manifests to the instance. Puppet is also responsible for starting the Cartridge Agent process. In the earlier releases, Puppet additionally started the service processes, for example Tomcat server etc. However, in the new release it is the responsibility of the Cartridge Agent to check and start the service processes. To achieve this, a Cartridge Agent plugin has to be written which will start the process.</p>

<p>The reason to move the responsibility of starting the service to the Cartridge Agent was to make sure that the services would not be starting without artifact distribution succeeding for repository based Cartridge types such as Tomcat, PHP or WSO2 Identity Server. For example, for a Tomcat instance, starting the Tomcat server without the repository artifacts not cloned in to the <code>webapps</code> folder, does not make any sense. Therefore, the service should not be up and the Cartridge Agent will not be publishing the InstanceActivatedEvent to the message broker.</p>

<p>Therefore for repository based Cartridge types, the service starter Cartridge Agent plugin should be mapped to the ArtifactsUpdatedEvent. If the Git clone operation performs successfully, the plugin will be executed and the service will be started. For non-repository based Cartridges such as MySQL, the service starter plugin can be mapped to InstanceStartedEvent.</p>

<p>After the Cartridge Agent is started it will start listening to the following topics in the message broker.
1. topology
2. tenant
3. instance/notifier
4. application/signup
5. domain/mapping</p>

<p>For the Cartridge Agent to successfully continue it should populate itself an idea of the services deployed in Stratos and how they are distributed. This is called the Topology in Stratos. The Topology describes what services are deployed, how clusters and members are deployed under those services and the lifecycle states of the clusters and the members.</p>

<p>The Topology information is distributed among Stratos components as a message broker event called the <code>CompleteTopologyEvent</code>. This is published every 60 seconds. The usual pattern for components to synchronize the Topology model is to receive the CompleteTopologyEvent only once and modify the topology based on the other events subsequently.</p>

<p>Therefore, the Cartridge Agent should wait until it receives the first CompleteTopologyEvent. As mentioned before, this waiting will be at most 60 seconds.</p>

<p>Just receiving the <code>CompleteTopologyEvent</code> is not sufficient. The Cartridge Agent should also verify that its instance is present in the Topology and the status of the instance is <code>INITIALIZED</code>. Usually, this will be the case when the first <code>CompleteTopologyEvent</code> is received, however there can be instance that it would be few minutes until the member is set to <code>INITIALIZED</code>. Cartridge Agent will also wait for that to happen.</p>

<p>After the instance status becomes <code>INITIALIZED</code> and the message broker topic listeners are registered, the Cartridge Agent will publish <code>InstanceStartedEvent</code> to the <code>instance\status</code> topic. This changes the status of the instance from <code>INITIALIZED</code> to <code>STARTED</code>.</p>

<h2>Started</h2>

<p>When the instance status changes to this state, the Cartridge Agent&rsquo;s next responsibility, from Stratos point of view, is to go in to the <code>ACTIVATED</code> state. This status is achieved through two effective flows, based on the type of the instance.</p>

<h3>Non-repo based instances</h3>

<p>If the instance is for example a MySQL instance, there is no need for a repository to be cloned inside (for most cases). In this case (determined by the absence of <code>REPO_URL</code> in the payload) the Cartridge agent checks if the service ports (ex: MySQL ports) are running and immediately publishes the <code>InstanceActivatedEvent</code>.</p>

<h3>Repo based instance</h3>

<p>In our case, the PHP instance is a repository based instance, where for example, a PHP application hosted on GitHub can be pointed to. If the <code>REPO_URL</code> is present on the payload the Cartridge Agent will move on without publishing the <code>InstanceActivatedEvent</code>. For a repo based instance, Stratos Manager will publish a separate event named <code>ArtifactUpdatedEvent</code> which the Cartridge Agent responds to by cloning the specified Git repository to the specified path. After the artifact repository is cloned, the Cartridge Agent will check if the service ports (in our case if Apache Server ports) are up and publish <code>InstanceActivatedEvent</code>.</p>

<h2>Activated</h2>

<p>Once the instance reaches the <code>ACTIVATED</code> stage, the initial tasks of the Cartridge Agent are done. It will periodically update the artifact repository based on the configuration, and would react to any events received via the message broker.</p>

<h2>Termination</h2>

<p>The instance can now go to either Pending Termination state if the application is undeployed. This is called a graceful shutdown flow, where the status of the instance switches from Active->Pending Termination->Obsolete->Terminated one after the other.</p>

<p>However, an instance can be directly classified as obsolete too, as described by the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">the first post</a> of this post series. If it fails to post health statistics events to the Complext Event Processor for more than 60 seconds, it will be classified as an obsolete instance and will be queued up for termination.</p>

<p>When an instance reaches the Pending Termination queue, an <code>InstanceCleanupMemberEvent</code> will be published to the message broker. The relevant instance picks up this event and does the necessary cleanup operations and subsequently publishes that it is ready to be terminated by publishing <code>InstanceReadyToShutdownEvent</code> to the message broker. When that happens it will be moved up to the obsolete queue.</p>

<p>There are timeout values for the instances to be in these queues. The default value for an instance to be in the pending termination member list is 30 minutes. If the relevant <code>InstanceReadyToShutdownEvent</code> doesn&rsquo;t get published within that timeout period, the instance will be automatically moved to the obsolete queue. If the member termination from the IaaS doesn&rsquo;t successfully complete within the default timeout value of 24 hours, it will be considered as an instance that cannot be terminated by Stratos and will be removed from the obsolete member list. The timeout values for these can be modified by modifying the <code>pendingTerminationMemberExpiryTimeout</code> and <code>obsoletedMemberExpiryTimeout</code> values respectively in the <code>&lt;STRATOS_HOME&gt;/repository/conf/autoscaler.xml</code> configuration file.</p>

<h1>Recap</h1>

<p>When the instance reaches its life time, so does this post series on the Apache Stratos Cartridge Agent. There are few minute details that have changed while this series was being compiled, however the overall information about the architecture and the function remains unchanged.</p>

<p>As always, the best strategy to understand the function is to go through the code. You can checkout the source for Apache Stratos from <a href="https://github.com/apache/stratos">GitHub</a>. Any issues or clarifications you come across can be quickly resolved by going through the <a href="https://cwiki.apache.org/confluence/display/STRATOS">documentation</a>. You can also get help and communicate with the Apache Stratos community via the mailing list.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2/">Apache Stratos Cartridge Agent: Instance Configuration by Puppet 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-21T23:25:09+05:30" pubdate data-updated="true">Mar 21<sup>st</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Chamila de Alwis)" rel="author">Chamila de Alwis</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a> <a class='category label label-primary' href='/blog/categories/cartridge-agent/'>cartridge agent</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">first article</a>?</p></blockquote>

<p>One of the main responsibilities of the Cartridge Agent is to start the services related the Cartridge type. To do this the Cartridge Agent should be configured with proper parameters. As we discussed in the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/">last article</a>, Puppet can be used to install, configure and start the Cartridge Agent. In this article, we will discuss how this is done in detail.</p>

<h1>Configurations</h1>

<p>The Cartridge Agent needs several parameters to start functioning correctly.</p>

<ol>
<li>Message broker IP address and port</li>
<li>Complex Event Processor IP address and port</li>
<li>Application path (for repository based cartridges)</li>
</ol>


<p>In addition to these parameters, there are several others which might be crucial to Cartridge Agent life cycle, based on different scenarios. However, at minimum, it needs the details of the above mentioned parameters to successfully function.</p>

<p>For orchestration in the VM scenario, we provide these values to Puppet, which in turn will configure the Cartridge Agent accordingly.</p>

<h2>base.pp</h2>

<p>The purpose of the <code>base.pp</code> in <code>/etc/puppet/manifests/nodes/</code> folder is to serve as a super node definition which can be inherited by service type node definitions. It contains a list of variables that can be used by any module that inherits it. As of Stratos 4.1.0 release the contents of the <code>base.pp</code> file looks like as follows. The variables are pretty much self explanatory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="s1">&#39;base&#39;</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  #essential variables</span>
</span><span class='line'>  <span class="nv">$package_repo</span>         <span class="o">=</span> <span class="s1">&#39;http://10.4.128.7&#39;</span>
</span><span class='line'>  <span class="nv">$local_package_dir</span>    <span class="o">=</span> <span class="s1">&#39;/mnt/packs&#39;</span>
</span><span class='line'>  <span class="nv">$mb_url</span>               <span class="o">=</span> <span class="s1">&#39;tcp://127.0.0.1:1883&#39;</span>
</span><span class='line'>  <span class="nv">$mb_type</span>              <span class="o">=</span> <span class="s1">&#39;activemq&#39;</span><span class="c-Singleline"> #in wso2 mb case, value should be &#39;wso2mb&#39;</span>
</span><span class='line'>  <span class="nv">$cep_ip</span>               <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'>  <span class="nv">$cep_port</span>             <span class="o">=</span> <span class="s1">&#39;7711&#39;</span>
</span><span class='line'>  <span class="nv">$cep_username</span>         <span class="o">=</span><span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$cep_password</span>         <span class="o">=</span><span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$truststore_password</span>  <span class="o">=</span> <span class="s1">&#39;wso2carbon&#39;</span>
</span><span class='line'>  <span class="nv">$java_distribution</span>    <span class="o">=</span> <span class="s1">&#39;jdk-7u51-linux-x64.tar.gz&#39;</span>
</span><span class='line'>  <span class="nv">$java_name</span>            <span class="o">=</span> <span class="s1">&#39;jdk1.7.0_51&#39;</span>
</span><span class='line'>  <span class="nv">$member_type_ip</span>       <span class="o">=</span> <span class="s1">&#39;private&#39;</span>
</span><span class='line'>  <span class="nv">$lb_httpPort</span>          <span class="o">=</span> <span class="s1">&#39;80&#39;</span>
</span><span class='line'>  <span class="nv">$lb_httpsPort</span>         <span class="o">=</span> <span class="s1">&#39;443&#39;</span>
</span><span class='line'>  <span class="nv">$tomcat_version</span>       <span class="o">=</span> <span class="s1">&#39;7.0.52&#39;</span>
</span><span class='line'>  <span class="nv">$enable_log_publisher</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
</span><span class='line'>  <span class="nv">$bam_ip</span>               <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'>  <span class="nv">$bam_port</span>             <span class="o">=</span> <span class="s1">&#39;7611&#39;</span>
</span><span class='line'>  <span class="nv">$bam_secure_port</span>      <span class="o">=</span> <span class="s1">&#39;7711&#39;</span>
</span><span class='line'>  <span class="nv">$bam_username</span>         <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$bam_password</span>         <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$metadata_service_url</span> <span class="o">=</span> <span class="s1">&#39;https://127.0.0.1:9443&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">require</span> <span class="nc">stratos_base</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The <code>base.pp</code> file should be modified to include proper values when the Puppet master is configured.</p>

<h2>Cartridge Agent modules</h2>

<p>Apache Stratos 4.1.0 ships with two implementations of the Cartridge Agent, default Java agent and a Python based agent. The respective Puppet modules for these implementations are <code>agent</code> and <code>python_agent</code> inside <code>/etc/puppet/modules</code> folder.</p>

<p>Both modules have a similar flow of execution, where there are separate steps to,</p>

<ol>
<li>Copy the Cartridge Agent distribution from the Puppet master to the instance</li>
<li>Copy templates reflecting configuration files, Cartridge Agent extensions and plugins, and configure parameters as given by <code>base.pp</code> and calling modules</li>
<li>Start Cartridge Agent</li>
</ol>


<p>If a calling module (the module which includes the Cartridge Agent module, typically a service type like PHP) needs to override a value provided through base.pp it can do so by assigning the new value to the variable at the time of Puppet module inclusion.</p>

<h3>Cartridge Agent Extensions and Plugins</h3>

<p>In addition to <a href="http://code.chamiladealwis.com/2015/03/17/apache-stratos-cartridge-agent-contract/">what the Cartridge Agent does as a generic agent to all services</a>, each service can make use of extensions, and in the Python implementation, plugins to add additional behavior to it. We will go in to more details about the extensions and plugins in a separate article, however you only need to be aware of them as being executed for specified events that are processed by the Cartridge Agent. For example, you can have an extension that can be specified to be executed, when an ArtifactUpdatedEvent is processed by the Cartridge Agent.</p>

<p>For each service that includes the Puppet module for a certain implementation of the Cartridge Agent, it can specify a list of extensions and plugins that should be copied over to the Cartridge Agent. For example, this is how the PHP module specifies the list of plugins and extensions that should be included in the Cartridge Agent, when the running service is PHP.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'>  <span class="nv">$custom_agent_templates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;extensions/artifacts-updated.sh&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nv">$custom_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;plugins/PhpServerStarterPlugin.py&#39;</span><span class="p">,</span> <span class="s1">&#39;plugins/PhpServerStarterPlugin.yapsy-plugin&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span><span class="s1">&#39;python_agent&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">custom_templates</span> <span class="p">=&gt;</span> <span class="nv">$custom_agent_templates</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">custom_plugins</span> <span class="p">=&gt;</span> <span class="nv">$custom_plugins</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">module</span><span class="p">=&gt;</span><span class="s1">&#39;php&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the Cartridge Agent is executing, these specified extensions and plugins will be executed when their respective events are processed.</p>

<p>As mentioned above, it is the responsibility of the Cartridge Agent to start the respective services related to the spawned Cartridge. This is also done using a Cartridge Agent plugin (Python implementation) or an extension (Java implementation).</p>

<h1>Conclusion for Configuration</h1>

<p>By the end of this article, we should be aware of the details of the configuration needed by the Cartridge Agent. At least, that was my intention. If you feel like I&rsquo;ve missed a crucial explanation, feel free to drop a comment.</p>

<p>As of now, Apache Stratos only supports Puppet as a configuration tool for Cartridge instances. However in the future releases, it will also be possible use Chef, or another similar tool as a replacement for Puppet.</p>

<p>From this point onwards, we will start on the details of the Cartridge Agent life cycle execution. For that we will first go through a typical work flow of a PHP Cartridge instance&hellip;. in the next article!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/">Apache Stratos Cartridge Agent: Instance Configuration by Puppet 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-17T05:43:48+05:30" pubdate data-updated="true">Mar 17<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Chamila de Alwis)" rel="author">Chamila de Alwis</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a> <a class='category label label-primary' href='/blog/categories/cartridge-agent/'>cartridge agent</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">first article</a>?</p></blockquote>

<h1>Instance Configuration</h1>

<p>When an application is deployed in Apache Stratos, what happens is that for each cartridge in the application, an instance creation call is made to the configured IaaS via the Cloud Controller component. This call contains only the base image ID (in OpenStack this is an image UUID, in Amazon EC2 this is an AMI), the instance creation parameters like the instance flavor, security group etc and the payload of Stratos related information that is targeted to that particular instance. So how does the actual configuration of a spawned Virtual Machine happen? (We will discuss the exciting Kubernetes + Docker work flow separately)</p>

<p>The answer, my friend, is <em>dancing</em> in the wind, like a puppet.</p>

<p>Yes, with that bad pun sentence thingy, I&rsquo;ve introduced you to Puppet, the tool which configures each and every instance spawned by Stratos.</p>

<h2>Puppeteering: A brief introduction</h2>

<p>Simply said, Puppet automates the configuration details of a machine to bring it to an intended state. Let&rsquo;s take a scenario where you have to configure and start a LAMP stack on a single machine. Without Puppet you will be doing the following tasks manually.</p>

<ol>
<li>Update the package management system and install util packages</li>
<li>Install and configure HTTPD</li>
<li>Install PHP and configure with HTTPD</li>
<li>Install and configure MySQL</li>
<li>A precautionary HTTPD restart</li>
</ol>


<p>With Puppet, you will be defining all these steps in a manifest file, using Puppet&rsquo;s Ruby based DSL. Nope, that is not what a Puppet manifest contains. What you will be actually defining in a Puppet manifest will be the intended state of the machine. For example, you will be defining a list of packages that should be present (or not), the lines of configuration a certain file should have, and the list of services that should be running (or not), in the configured machine (&ldquo;What&rsquo;s difference&rdquo; you ask? Well, the difference is that, for example, Puppet wouldn&rsquo;t try to execute an install action on a package that is already there in the system).</p>

<p>You can apply this Puppet manifest in the target machine and the Puppet agent will make sure each state is changed to the intended state, and at the end of the Puppet run (if you wrote the manifest correctly) a LAMP stack will be ready for you.</p>

<p>A Puppet setup consists of a server-client architecture. The Puppet server is called (surprisingly) the <code>Puppet Master</code>, and the client is the <code>Puppet agent</code>. You can add Puppet <em>modules</em> for each service (modularizing services is arbitrary, you can break your configuration in to modules at any level), to the Puppet master, then add the machines which needs to be configured (each of these machines should have Puppet agent installed), define nodes (ex: LAMP, database, LAP etc) and classify each machine to the nodes. Upon classification, the modules defined by each node will be applied by the Puppet agent in the target machines.</p>

<p>In our little example, we can have different Puppet modules for HTTPD, PHP, and MySQL, and then define node types for LAMP (which uses all three modules), Database (which only uses the MySQL module) and LAP (which uses only the HTTPD and the PHP modules). As you&rsquo;d probably start to see, modules and nodes are a reuse strategy.</p>

<h2>Puppet in Stratos</h2>

<p>The intended Puppet strategy in Stratos is to define each cartridge as a Puppet node definition. For the PHP cartridge there will be a PHP Puppet node definition in the Puppet master. In turn, each node definition should be an aggregate of the following Puppet modules (ex: PHP).</p>

<ul>
<li>stratos_base &ndash; Installs common utility packages needed by every cartridge</li>
<li>service module &ndash; PHP</li>
<li>cartridge_agent &ndash; Python or Java Agent (and Java module if Java agent is used)</li>
</ul>


<p>The PHP node definition should have something like the following that defines in which order these modules should be applied.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">Class</span><span class="p">[</span><span class="s1">&#39;stratos_base&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;php&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;python_agent&#39;</span><span class="p">]</span>
</span><span class='line'><span class="err">#</span> <span class="ss">or</span> <span class="ss">if</span> <span class="ss">we</span> <span class="ss">are</span> <span class="ss">using</span> <span class="ss">the</span> <span class="ss">Java</span> <span class="ss">implementation</span> <span class="ss">of</span> <span class="ss">the</span> <span class="ss">Cartridge</span> <span class="ss">Agent</span>
</span><span class='line'><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;stratos_base&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;php&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;java&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To state the almost obvious, this Puppet directive states that the Puppet classes (which are <em>in no way</em> associated with the classes in OOP) <code>stratos_base</code>, <code>php</code>, (<code>java</code>, <code>agent</code>) | (<code>python_agent</code>) should be applied one after the other, or <code>python_agent</code> depends on <code>php</code> module, and <code>php</code> depends on <code>stratos_base</code> module. Apache Stratos ships a standard set of Puppet modules related to a various set of cartridge types, which are supported out of the box.</p>

<p>All of this aside, how does Puppet master know which node definition to be applied to which instance? Unlike the usual work flow where a listed machine is classified manually from the Puppet master web interface, this is done automatically in Stratos. To understand this classification, we need to understand how the initialization of an instance happens when it is spawned in the IaaS.</p>

<h1>Base Images and init scripts</h1>

<p>As I&rsquo;ve mentioned earlier, when spawning an instance from the IaaS, Stratos specifies a <em>base image</em> to spawn that particular instance from. Where does this base image come from? As a Stratos <em>user</em> you will most likely not be working with cartridge definitions and base images. However as a <em>sysadmin</em> working with a Stratos deployment you will be defining various cartridge types, their Puppet modules, and the base images to spawn these cartridge instances.</p>

<p>A base image is, simply said, an initial state of a Virtual machine, from where the execution can start. There can be a base image which only contains the Operating System, or there can be a base image which has gone a little bit further and installed a few of the services as well. It&rsquo;s a like a VM snapshot you take on VirtualBox, a starting point with a certain set of work already done, that otherwise need to be done to spawn a working instance. At most this should contain an Operating System. A Stratos Cartridge base image should have more, to be precise the following, to be a minimal (or as it is called in Stratos, a <em>default</em>) base image.</p>

<ol>
<li>Operating system</li>
<li>Utility packages (zip, unzip, etc)</li>
<li>Puppet agent</li>
<li>A Stratos init script</li>
</ol>


<p>Others being self explanatory, an init script is simply a bash script which is copied in to the <code>/root/bin</code> folder <a href="https://cwiki.apache.org/confluence/display/STRATOS/4.1.0+Creating+a+Cartridge+on+OpenStack">at the time of the creation of the base image</a>. This script is then automatically executed when the instance is started. An init script&rsquo;s tasks should be the following in the stated order, in the context of a Stratos cartridge instance.</p>

<ol>
<li>Retrieve payload parameters related to the spawned instance from the IaaS meta-data service (<a href="http://docs.openstack.org/admin-guide-cloud/content/section_metadata-service.html">in OpenStack</a>)</li>
<li>Parse payload parameters and set configuration values in the instance.</li>
<li>Include service name (ex: php, tomcat i.e. the cartridge type) and the Puppet master host name, in the instance host name. (Yes, this is what we should look at to understand the communication between the Puppet agent and the master in Stratos)</li>
<li>Execute Puppet agent</li>
</ol>


<p>The Puppet agent will apply the retrieved catalogs from the Puppet master and start the Cartridge Agent.</p>

<h2>Payload Parameters</h2>

<p>Ever IaaS has a meta-data service where instance specific data can be written to it to be queried by the instance. For an example, in OpenStack this service can be accessed by making a <code>wget</code> call to <code>http://169.254.169.254/latest/user-data</code> URL. When Stratos makes a instance spawn call to the IaaS (via JClouds library), it passes a set of payload parameters that are specific to the instance. This payload looks something like the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="err">SERVICE_NAME</span>         <span class="err">=php</span>
</span><span class='line'><span class="err">HOST_NAME</span>            <span class="err">=newoice.stratos.com</span>
</span><span class='line'><span class="err">MULTITENANT</span>          <span class="err">=false</span>
</span><span class='line'><span class="err">TENANT_ID</span>            <span class="err">=-1234</span>
</span><span class='line'><span class="err">TENANT_RANGE</span>         <span class="err">=-1234</span>
</span><span class='line'><span class="err">CARTRIDGE_ALIAS</span>      <span class="err">=newoice</span>
</span><span class='line'><span class="err">CLUSTER_ID</span>           <span class="err">=newoice.php.domain</span>
</span><span class='line'><span class="err">CARTRIDGE_KEY</span>        <span class="err">=BNdP01v8VEQPPYGY</span>
</span><span class='line'><span class="err">DEPLOYMENT</span>           <span class="err">=default</span>
</span><span class='line'><span class="err">REPO_URL</span>             <span class="err">=https://github.com/chamilad/NeWoice.git</span>
</span><span class='line'><span class="err">PORTS</span>                <span class="err">=80</span>
</span><span class='line'><span class="err">PUPPET_IP</span>            <span class="err">=192.133.10.53</span>
</span><span class='line'><span class="err">PUPPET_HOSTNAME</span>      <span class="err">=puppet.chamilad.org</span>
</span><span class='line'><span class="err">COMMIT_ENABLED</span>       <span class="err">=false</span>
</span><span class='line'><span class="err">MEMBER_ID</span>            <span class="err">=newoice.php.domain192a96cd-844e-4dca-a829-a63664d29724</span>
</span><span class='line'><span class="err">LB_CLUSTER_ID</span>        <span class="err">=null</span>
</span><span class='line'><span class="err">NETWORK_PARTITION_ID</span> <span class="err">=openstack1</span>
</span><span class='line'><span class="err">PARTITION_ID</span>         <span class="err">=p1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, the main fields to notice here are the <code>SERVICE_NAME</code>, <code>DEPLOYMENT</code> <code>PUPPET_IP</code>, and <code>PUPPET_HOSTNAME</code>. Why are they important? Because they are the main</p>

<h2>Configuration Values</h2>

<p>(See what I did there? <em>nudge nudge</em> ..aaaanyways) The init script makes use of (mainly) these values to formulate the hostname of the newly spawned instance. It will be of format <code>{random_number}.DEPLOYMENT.SERVICE_NAME.PUPPET_HOSTNAME</code>. For example the instance hostname resulting from the above payload would look like something as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="err">2324332342243.default.php.puppet.chamilad.org</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why is the Puppet master hostname suffixed to the instance hostname? That is because of the way Puppet master and the agent communicates.</p>

<p>For the secure communication between the Puppet agent and the master, a certificate is generated and signed by the Puppet master&rsquo;s in built Certificate Authority. Likewise, the client should also provide a signed certificate to prove its identity. At the initial moment when the connection between agent and the master establishes, the agent creates a certificate request and provide to the master. In Stratos Puppet master, a feature has been enabled, called AutoSign, which automatically signs and approves the certificate requests as long as their domain names is suffixed with Puppet master hostname. You can check this configuration, and change it even, at the <code>/etc/puppet/autosign.conf</code> file. If you change it, just keep in mind that the functionality of the init script will also have to be changed to let the agent certificate requests be signed automatically.</p>

<p>Okay. Now I&rsquo;ve forgotten what we were trying to understand by going this much deep in the code. Ah! Here it is! <em>&ldquo;How does the Puppet master automatically classify nodes to different Cartridge types?&rdquo;</em></p>

<p>Look at our sample hostname of the spawned PHP instance. Just before suffixing the Puppet master hostname, the Service name of the Cartridge is suffixed. So this hostname String will match the regex pattern of <code>/php/</code>. And that is what exactly happens at the Puppet master side. Each node, being a service type, is matched with a regular expression in the hostname of the Puppet agent. If you look at the different node definitions inside <code>/etc/puppet/manifests/nodes/</code> folder in the Stratos Puppet master, you will see that each node definition maps to a service type. For example the node definition of the PHP service looks something like the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="sr">/php/</span> <span class="kd">inherits</span> <span class="s">base</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$docroot</span> <span class="o">=</span> <span class="s2">&quot;/var/www/www&quot;</span>
</span><span class='line'>  <span class="nv">$syslog</span><span class="o">=</span><span class="s2">&quot;/var/log/apache2/error.log&quot;</span>
</span><span class='line'>  <span class="nv">$samlalias</span><span class="o">=</span><span class="s2">&quot;/var/www/&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span><span class="s1">&#39;php&#39;</span><span class="p">:}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Notice the node name being a regex? (The parent node, <code>base</code> defines a set of common variables that are useful to all or multiple Puppet modules, such as the Message Broker URL, Java distribution name etc). That is what gets matched to the Puppet agent certificate&rsquo;s hostname.</p>

<p>Now that we have an overall understanding of the Puppet context in Stratos let&rsquo;s take a look at how Puppet configures and starts the services in a spawned instance&hellip;. in the next article!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">Apache Stratos Cartridge Agent: Day 0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-17T04:25:03+05:30" pubdate data-updated="true">Mar 17<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Chamila de Alwis)" rel="author">Chamila de Alwis</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a> <a class='category label label-primary' href='/blog/categories/cartridge-agent/'>cartridge agent</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>As the first post of a series of comprehensive guide to the Apache Stratos Cartridge Agent, let&rsquo;s look at the Cartridge Agent contract. Keep tuned in and expect more detailed explanations on the instance and Cartridge Agent configuration, workflow, different Cartridge Agent implementations, their configurations and newly introduced plugin system in the Python implementation.</p>

<h1>Role of the Cartridge Agent</h1>

<p>When the instances are spawned in Apache Stratos, there are a few requirements that the particular instance should fulfill. It should</p>

<ol>
<li>Listen to the message broker events that are intended to it and publish events notifying any listening parties of its current state (STARTED|ACTIVATED|MAINTENANCE_MODE etc)</li>
<li>Check if the intended ports of the instance are active or not and publish the status accordingly</li>
<li>Periodically check the health statistics of the instance and publish them to an expecting <a href="http://code.chamiladealwis.com/blog/2014/10/10/thrift-communication-in-apache-stratos/">Thrift compatible</a> Complex Event Processor</li>
<li>Clone from and constantly update an artifact repository if specified</li>
</ol>


<p>It&rsquo;s obvious that there should be an independent common component in each instance that fulfills these requests. And just like that, we&rsquo;ve stated the case for the cartridge agent.</p>

<h2>Message broker communication</h2>

<p>Apache Stratos has a loosely-coupled component structure which executes the major communication bulk over a message broker. This enables any new component to join the chit-chat without disrupting the ongoing communication or without any impact on the configuration of the existing components. Any component can go silent and it wouldn&rsquo;t affect the communication channel. The communication happens via message broker <em>Events</em> and <em>Topics</em> in the common communication channel. Therefore each component should only be aware of the location (and sometimes the credentials) of the common communication channel, the message broker.</p>

<p>The Cartridge Agent connects to the message broker, publishes its initial status and listens to the <em>topics</em> for any events that are important to it. We&rsquo;ll see what these events are and what their impact would be on the work flow of the agent in the walk through section.</p>

<h2>Ports activity check</h2>

<p>For each cartridge, a set of ports are defined in the cartridge definition. The intended services should run on these ports. The agent should determine if a the intended service is up or not before it can announce that it is ready to accept requests. It does so by checking if the specified ports are active or not.</p>

<h2>Health statistics publishing</h2>

<p>The Cloud is about Scale, and Scale is about Health. Apache Stratos auto-scaling feature takes care of the complex scaling requirements of the deployed services based on a number of parameters, on a number of levels. From the point of the instance, its contribution to the scaling effort should be to announce its health status to the decision making process.</p>

<p>The agent does this by collecting the memory usage and the load average values of the running instance and publishing them to a real time Complex Event Processor via Apache Thrift protocol. (Why doesn&rsquo;t it use the broker channel? Well, it&rsquo;s too darn slow to begin with for a real time event to be <em>real time</em>. Hammer and the problem anyone?) It does this periodically, usually every 15 seconds. If an instance stops publishing health stats events and stays dark for more than 60 seconds, the Complex Event Processor considers that instance to be a hopeless case and announces that an instance has gone dark. The auto-scaler, upon receiving this announcement (an <em>Event</em> published on a <em>topic</em> as you might have guessed), issues orders to terminate the faulty instance and spawn a new instance to take the place of the fallen comrade.</p>

<h2>Artifacts Distribution</h2>

<p>Most cartridge types deal with a set of artifacts that are hosted on a remote repository, that should be copied over to the instance and executed on. For an example a PHP cartridge will require a remote repository location to copy the web artifacts from. It is the Cartridge Agent that performs this artifact management task. In addition to cloning from the remote repository, there are cases where the locally modified artifacts should be pushed to the remote repository. This is also carried out by the Cartridge Agent.</p>

<p>It is the responsibility of the Cartridge Agent to manage all the tasks and make sure the instance goes through its intended life cycle. But, who configures and starts the Cartridge Agent? Keeping aside the philosophical overtone of that question, let&rsquo;s take a look at the instance configuration process in the next article before diving in to the Cartridge Agent life cycle itself.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - chamila -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chamila-01';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
