
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>nuts!</title>
  <meta name="author" content="chamila de alwis">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chamilad.github.io">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="nuts!" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/application.js"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Arvo' rel='stylesheet' type='text/css'>
  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li class="active"><a href="/index.html">Home</a></li>
    
        <li ><a href="/about">About</a></li>
    
        <li ><a href="/archives">Archive</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/chamilad" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="http://linkedin.com/in/chamiladealwis" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://twitter.com/chamilad" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://plus.google.com/102488741988320223009" title="Google+ Profile"><i class="icon-google-plus-sign social-navbar"></i></a></li>
    
    
    

    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
      <div class="row-fluid">
        <div id="content">
          <div class="jumbotron">
  <div class="container">
    
      nuts!
    
    <h3 class="tagline">
      
        For the night is dark and I&#8217;d probably forget this by tomorrow
      
    </h3>
  </div>
</div>


<div class="blog-index">
  
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-03-21T23:25:09+05:30" pubdate data-updated="true">Mar 21<sup>st</sup>, 2015</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/apache-stratos/"><span class="badge">apache stratos</span></a>
          
          <a href="/blog/categories/cartridge-agent/"><span class="badge">cartridge agent</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2/">Apache Stratos Cartridge Agent: Instance Configuration by Puppet 2</a></h1>
      <blockquote><p>This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">first article</a>?</p></blockquote>

<p>One of the main responsibilities of the Cartridge Agent is to start the services related the Cartridge type. To do this the Cartridge Agent should be configured with proper parameters. As we discussed in the [last article])(<a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/">http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/</a>), Puppet can be used to install, configure and start the Cartridge Agent. In this article, we will discuss how this is done in detail.</p>

<h1>Configurations</h1>

<p>The Cartridge Agent needs several parameters to start functioning correctly.</p>

<ol>
<li>Message broker IP address and port</li>
<li>Complex Event Processor IP address and port</li>
<li>Application path (for repository based cartridges)</li>
</ol>


<p>In addition to these parameters, there are several others which might be crucial to Cartridge Agent life cycle, based on different scenarios. However, at minimum, it needs the details of the above mentioned parameters to successfully function.</p>

<p>For orchestration in the VM scenario, we provide these values to Puppet, which in turn will configure the Cartridge Agent accordingly.</p>

<h2>base.pp</h2>

<p>The purpose of the <code>base.pp</code> in <code>/etc/puppet/manifests/nodes/</code> folder is to serve as a super node definition which can be inherited by service type node definitions. It contains a list of variables that can be used by any module that inherits it. As of Stratos 4.1.0 release the contents of the <code>base.pp</code> file looks like as follows. The variables are pretty much self explanatory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="s1">&#39;base&#39;</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  #essential variables</span>
</span><span class='line'>  <span class="nv">$package_repo</span>         <span class="o">=</span> <span class="s1">&#39;http://10.4.128.7&#39;</span>
</span><span class='line'>  <span class="nv">$local_package_dir</span>    <span class="o">=</span> <span class="s1">&#39;/mnt/packs&#39;</span>
</span><span class='line'>  <span class="nv">$mb_url</span>               <span class="o">=</span> <span class="s1">&#39;tcp://127.0.0.1:1883&#39;</span>
</span><span class='line'>  <span class="nv">$mb_type</span>              <span class="o">=</span> <span class="s1">&#39;activemq&#39;</span><span class="c-Singleline"> #in wso2 mb case, value should be &#39;wso2mb&#39;</span>
</span><span class='line'>  <span class="nv">$cep_ip</span>               <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'>  <span class="nv">$cep_port</span>             <span class="o">=</span> <span class="s1">&#39;7711&#39;</span>
</span><span class='line'>  <span class="nv">$cep_username</span>         <span class="o">=</span><span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$cep_password</span>         <span class="o">=</span><span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$truststore_password</span>  <span class="o">=</span> <span class="s1">&#39;wso2carbon&#39;</span>
</span><span class='line'>  <span class="nv">$java_distribution</span>    <span class="o">=</span> <span class="s1">&#39;jdk-7u51-linux-x64.tar.gz&#39;</span>
</span><span class='line'>  <span class="nv">$java_name</span>            <span class="o">=</span> <span class="s1">&#39;jdk1.7.0_51&#39;</span>
</span><span class='line'>  <span class="nv">$member_type_ip</span>       <span class="o">=</span> <span class="s1">&#39;private&#39;</span>
</span><span class='line'>  <span class="nv">$lb_httpPort</span>          <span class="o">=</span> <span class="s1">&#39;80&#39;</span>
</span><span class='line'>  <span class="nv">$lb_httpsPort</span>         <span class="o">=</span> <span class="s1">&#39;443&#39;</span>
</span><span class='line'>  <span class="nv">$tomcat_version</span>       <span class="o">=</span> <span class="s1">&#39;7.0.52&#39;</span>
</span><span class='line'>  <span class="nv">$enable_log_publisher</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
</span><span class='line'>  <span class="nv">$bam_ip</span>               <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'>  <span class="nv">$bam_port</span>             <span class="o">=</span> <span class="s1">&#39;7611&#39;</span>
</span><span class='line'>  <span class="nv">$bam_secure_port</span>      <span class="o">=</span> <span class="s1">&#39;7711&#39;</span>
</span><span class='line'>  <span class="nv">$bam_username</span>         <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$bam_password</span>         <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$metadata_service_url</span> <span class="o">=</span> <span class="s1">&#39;https://127.0.0.1:9443&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">require</span> <span class="nc">stratos_base</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The <code>base.pp</code> file should be modified to include proper values when the Puppet master is configured.</p>

<h2>Cartridge Agent modules</h2>

<p>Apache Stratos 4.1.0 ships with two implementations of the Cartridge Agent, default Java agent and a Python based agent. The respective Puppet modules for these implementations are <code>agent</code> and <code>python_agent</code> inside <code>/etc/puppet/modules</code> folder.</p>

<p>Both modules have a similar flow of execution, where there are separate steps to,</p>

<ol>
<li>Copy the Cartridge Agent distribution from the Puppet master to the instance</li>
<li>Copy templates reflecting configuration files, Cartridge Agent extensions and plugins, and configure parameters as given by <code>base.pp</code> and calling modules</li>
<li>Start Cartridge Agent</li>
</ol>


<p>If a calling module (the module which includes the Cartridge Agent module, typically a service type like PHP) needs to override a value provided through base.pp it can do so by assigning the new value to the variable at the time of Puppet module inclusion.</p>

<h3>Cartridge Agent Extensions and Plugins</h3>

<p>In addition to <a href="http://code.chamiladealwis.com/2015/03/17/apache-stratos-cartridge-agent-contract/">what the Cartridge Agent does as a generic agent to all services</a>, each service can make use of extensions, and in the Python implementation, plugins to add additional behavior to it. We will go in to more details about the extensions and plugins in a separate article, however you only need to be aware of them as being executed for specified events that are processed by the Cartridge Agent. For example, you can have an extension that can be specified to be executed, when an ArtifactUpdatedEvent is processed by the Cartridge Agent.</p>

<p>For each service that includes the Puppet module for a certain implementation of the Cartridge Agent, it can specify a list of extensions and plugins that should be copied over to the Cartridge Agent. For example, this is how the PHP module specifies the list of plugins and extensions that should be included in the Cartridge Agent, when the running service is PHP.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'>  <span class="nv">$custom_agent_templates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;extensions/artifacts-updated.sh&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nv">$custom_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;plugins/PhpServerStarterPlugin.py&#39;</span><span class="p">,</span> <span class="s1">&#39;plugins/PhpServerStarterPlugin.yapsy-plugin&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span><span class="s1">&#39;python_agent&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">custom_templates</span> <span class="p">=&gt;</span> <span class="nv">$custom_agent_templates</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">custom_plugins</span> <span class="p">=&gt;</span> <span class="nv">$custom_plugins</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">module</span><span class="p">=&gt;</span><span class="s1">&#39;php&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the Cartridge Agent is executing, these specified extensions and plugins will be executed when their respective events are processed.</p>

<p>As mentioned above, it is the responsibility of the Cartridge Agent to start the respective services related to the spawned Cartridge. This is also done using a Cartridge Agent plugin (Python implementation) or an extension (Java implementation).</p>

<h1>Conclusion for Configuration</h1>

<p>By the end of this article, we should be aware of the details of the configuration needed by the Cartridge Agent. At least, that was my intention. If you feel like I&rsquo;ve missed a crucial explanation, feel free to drop a comment.</p>

<p>As of now, Apache Stratos only supports Puppet as a configuration tool for Cartridge instances. However in the future releases, it will also be possible use Chef, or another similar tool as a replacement for Puppet.</p>

<p>From this point onwards, we will start on the details of the Cartridge Agent life cycle execution. For that we will first go through a typical work flow of a PHP Cartridge instance&hellip;. in the next article!</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-03-17T05:43:48+05:30" pubdate data-updated="true">Mar 17<sup>th</sup>, 2015</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/apache-stratos/"><span class="badge">apache stratos</span></a>
          
          <a href="/blog/categories/cartridge-agent/"><span class="badge">cartridge agent</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/">Apache Stratos Cartridge Agent: Instance Configuration by Puppet 1</a></h1>
      <blockquote><p>This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">first article</a>?</p></blockquote>

<h1>Instance Configuration</h1>

<p>When an application is deployed in Apache Stratos, what happens is that for each cartridge in the application, an instance creation call is made to the configured IaaS via the Cloud Controller component. This call contains only the base image ID (in OpenStack this is an image UUID, in Amazon EC2 this is an AMI), the instance creation parameters like the instance flavor, security group etc and the payload of Stratos related information that is targeted to that particular instance. So how does the actual configuration of a spawned Virtual Machine happen? (We will discuss the exciting Kubernetes + Docker work flow separately)</p>

<p>The answer, my friend, is <em>dancing</em> in the wind, like a puppet.</p>

<p>Yes, with that bad pun sentence thingy, I&rsquo;ve introduced you to Puppet, the tool which configures each and every instance spawned by Stratos.</p>

<h2>Puppeteering: A brief introduction</h2>

<p>Simply said, Puppet automates the configuration details of a machine to bring it to an intended state. Let&rsquo;s take a scenario where you have to configure and start a LAMP stack on a single machine. Without Puppet you will be doing the following tasks manually.</p>

<ol>
<li>Update the package management system and install util packages</li>
<li>Install and configure HTTPD</li>
<li>Install PHP and configure with HTTPD</li>
<li>Install and configure MySQL</li>
<li>A precautionary HTTPD restart</li>
</ol>


<p>With Puppet, you will be defining all these steps in a manifest file, using Puppet&rsquo;s Ruby based DSL. Nope, that is not what a Puppet manifest contains. What you will be actually defining in a Puppet manifest will be the intended state of the machine. For example, you will be defining a list of packages that should be present (or not), the lines of configuration a certain file should have, and the list of services that should be running (or not), in the configured machine (&ldquo;What&rsquo;s difference&rdquo; you ask? Well, the difference is that, for example, Puppet wouldn&rsquo;t try to execute an install action on a package that is already there in the system).</p>

<p>You can apply this Puppet manifest in the target machine and the Puppet agent will make sure each state is changed to the intended state, and at the end of the Puppet run (if you wrote the manifest correctly) a LAMP stack will be ready for you.</p>

<p>A Puppet setup consists of a server-client architecture. The Puppet server is called (surprisingly) the <code>Puppet Master</code>, and the client is the <code>Puppet agent</code>. You can add Puppet <em>modules</em> for each service (modularizing services is arbitrary, you can break your configuration in to modules at any level), to the Puppet master, then add the machines which needs to be configured (each of these machines should have Puppet agent installed), define nodes (ex: LAMP, database, LAP etc) and classify each machine to the nodes. Upon classification, the modules defined by each node will be applied by the Puppet agent in the target machines.</p>

<p>In our little example, we can have different Puppet modules for HTTPD, PHP, and MySQL, and then define node types for LAMP (which uses all three modules), Database (which only uses the MySQL module) and LAP (which uses only the HTTPD and the PHP modules). As you&rsquo;d probably start to see, modules and nodes are a reuse strategy.</p>

<h2>Puppet in Stratos</h2>

<p>The intended Puppet strategy in Stratos is to define each cartridge as a Puppet node definition. For the PHP cartridge there will be a PHP Puppet node definition in the Puppet master. In turn, each node definition should be an aggregate of the following Puppet modules (ex: PHP).</p>

<ul>
<li>stratos_base &ndash; Installs common utility packages needed by every cartridge</li>
<li>service module &ndash; PHP</li>
<li>cartridge_agent &ndash; Python or Java Agent (and Java module if Java agent is used)</li>
</ul>


<p>The PHP node definition should have something like the following that defines in which order these modules should be applied.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="nc">Class</span><span class="p">[</span><span class="s1">&#39;stratos_base&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;php&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;python_agent&#39;</span><span class="p">]</span>
</span><span class='line'><span class="err">#</span> <span class="ss">or</span> <span class="ss">if</span> <span class="ss">we</span> <span class="ss">are</span> <span class="ss">using</span> <span class="ss">the</span> <span class="ss">Java</span> <span class="ss">implementation</span> <span class="ss">of</span> <span class="ss">the</span> <span class="ss">Cartridge</span> <span class="ss">Agent</span>
</span><span class='line'><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;stratos_base&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;php&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;java&#39;</span><span class="p">]</span><span class="err">-&gt;</span><span class="ss">Class</span><span class="err">[</span><span class="s1">&#39;agent&#39;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To state the almost obvious, this Puppet directive states that the Puppet classes (which are <em>in no way</em> associated with the classes in OOP) <code>stratos_base</code>, <code>php</code>, (<code>java</code>, <code>agent</code>) | (<code>python_agent</code>) should be applied one after the other, or <code>python_agent</code> depends on <code>php</code> module, and <code>php</code> depends on <code>stratos_base</code> module. Apache Stratos ships a standard set of Puppet modules related to a various set of cartridge types, which are supported out of the box.</p>

<p>All of this aside, how does Puppet master know which node definition to be applied to which instance? Unlike the usual work flow where a listed machine is classified manually from the Puppet master web interface, this is done automatically in Stratos. To understand this classification, we need to understand how the initialization of an instance happens when it is spawned in the IaaS.</p>

<h1>Base Images and init scripts</h1>

<p>As I&rsquo;ve mentioned earlier, when spawning an instance from the IaaS, Stratos specifies a <em>base image</em> to spawn that particular instance from. Where does this base image come from? As a Stratos <em>user</em> you will most likely not be working with cartridge definitions and base images. However as a <em>sysadmin</em> working with a Stratos deployment you will be defining various cartridge types, their Puppet modules, and the base images to spawn these cartridge instances.</p>

<p>A base image is, simply said, an initial state of a Virtual machine, from where the execution can start. There can be a base image which only contains the Operating System, or there can be a base image which has gone a little bit further and installed a few of the services as well. It&rsquo;s a like a VM snapshot you take on VirtualBox, a starting point with a certain set of work already done, that otherwise need to be done to spawn a working instance. At most this should contain an Operating System. A Stratos Cartridge base image should have more, to be precise the following, to be a minimal (or as it is called in Stratos, a <em>default</em>) base image.</p>

<ol>
<li>Operating system</li>
<li>Utility packages (zip, unzip, etc)</li>
<li>Puppet agent</li>
<li>A Stratos init script</li>
</ol>


<p>Others being self explanatory, an init script is simply a bash script which is copied in to the <code>/root/bin</code> folder <a href="https://cwiki.apache.org/confluence/display/STRATOS/4.1.0+Creating+a+Cartridge+on+OpenStack">at the time of the creation of the base image</a>. This script is then automatically executed when the instance is started. An init script&rsquo;s tasks should be the following in the stated order, in the context of a Stratos cartridge instance.</p>

<ol>
<li>Retrieve payload parameters related to the spawned instance from the IaaS meta-data service (<a href="http://docs.openstack.org/admin-guide-cloud/content/section_metadata-service.html">in OpenStack</a>)</li>
<li>Parse payload parameters and set configuration values in the instance.</li>
<li>Include service name (ex: php, tomcat i.e. the cartridge type) and the Puppet master host name, in the instance host name. (Yes, this is what we should look at to understand the communication between the Puppet agent and the master in Stratos)</li>
<li>Execute Puppet agent</li>
</ol>


<p>The Puppet agent will apply the retrieved catalogs from the Puppet master and start the Cartridge Agent.</p>

<h2>Payload Parameters</h2>

<p>Ever IaaS has a meta-data service where instance specific data can be written to it to be queried by the instance. For an example, in OpenStack this service can be accessed by making a <code>wget</code> call to <code>http://169.254.169.254/latest/user-data</code> URL. When Stratos makes a instance spawn call to the IaaS (via JClouds library), it passes a set of payload parameters that are specific to the instance. This payload looks something like the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="err">SERVICE_NAME</span>         <span class="err">=php</span>
</span><span class='line'><span class="err">HOST_NAME</span>            <span class="err">=newoice.stratos.com</span>
</span><span class='line'><span class="err">MULTITENANT</span>          <span class="err">=false</span>
</span><span class='line'><span class="err">TENANT_ID</span>            <span class="err">=-1234</span>
</span><span class='line'><span class="err">TENANT_RANGE</span>         <span class="err">=-1234</span>
</span><span class='line'><span class="err">CARTRIDGE_ALIAS</span>      <span class="err">=newoice</span>
</span><span class='line'><span class="err">CLUSTER_ID</span>           <span class="err">=newoice.php.domain</span>
</span><span class='line'><span class="err">CARTRIDGE_KEY</span>        <span class="err">=BNdP01v8VEQPPYGY</span>
</span><span class='line'><span class="err">DEPLOYMENT</span>           <span class="err">=default</span>
</span><span class='line'><span class="err">REPO_URL</span>             <span class="err">=https://github.com/chamilad/NeWoice.git</span>
</span><span class='line'><span class="err">PORTS</span>                <span class="err">=80</span>
</span><span class='line'><span class="err">PUPPET_IP</span>            <span class="err">=192.133.10.53</span>
</span><span class='line'><span class="err">PUPPET_HOSTNAME</span>      <span class="err">=puppet.chamilad.org</span>
</span><span class='line'><span class="err">COMMIT_ENABLED</span>       <span class="err">=false</span>
</span><span class='line'><span class="err">MEMBER_ID</span>            <span class="err">=newoice.php.domain192a96cd-844e-4dca-a829-a63664d29724</span>
</span><span class='line'><span class="err">LB_CLUSTER_ID</span>        <span class="err">=null</span>
</span><span class='line'><span class="err">NETWORK_PARTITION_ID</span> <span class="err">=openstack1</span>
</span><span class='line'><span class="err">PARTITION_ID</span>         <span class="err">=p1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, the main fields to notice here are the <code>SERVICE_NAME</code>, <code>DEPLOYMENT</code> <code>PUPPET_IP</code>, and <code>PUPPET_HOSTNAME</code>. Why are they important? Because they are the main</p>

<h2>Configuration Values</h2>

<p>(See what I did there? <em>nudge nudge</em> ..aaaanyways) The init script makes use of (mainly) these values to formulate the hostname of the newly spawned instance. It will be of format <code>{random_number}.DEPLOYMENT.SERVICE_NAME.PUPPET_HOSTNAME</code>. For example the instance hostname resulting from the above payload would look like something as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="err">2324332342243.default.php.puppet.chamilad.org</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why is the Puppet master hostname suffixed to the instance hostname? That is because of the way Puppet master and the agent communicates.</p>

<p>For the secure communication between the Puppet agent and the master, a certificate is generated and signed by the Puppet master&rsquo;s in built Certificate Authority. Likewise, the client should also provide a signed certificate to prove its identity. At the initial moment when the connection between agent and the master establishes, the agent creates a certificate request and provide to the master. In Stratos Puppet master, a feature has been enabled, called AutoSign, which automatically signs and approves the certificate requests as long as their domain names is suffixed with Puppet master hostname. You can check this configuration, and change it even, at the <code>/etc/puppet/autosign.conf</code> file. If you change it, just keep in mind that the functionality of the init script will also have to be changed to let the agent certificate requests be signed automatically.</p>

<p>Okay. Now I&rsquo;ve forgotten what we were trying to understand by going this much deep in the code. Ah! Here it is! <em>&ldquo;How does the Puppet master automatically classify nodes to different Cartridge types?&rdquo;</em></p>

<p>Look at our sample hostname of the spawned PHP instance. Just before suffixing the Puppet master hostname, the Service name of the Cartridge is suffixed. So this hostname String will match the regex pattern of <code>/php/</code>. And that is what exactly happens at the Puppet master side. Each node, being a service type, is matched with a regular expression in the hostname of the Puppet agent. If you look at the different node definitions inside <code>/etc/puppet/manifests/nodes/</code> folder in the Stratos Puppet master, you will see that each node definition maps to a service type. For example the node definition of the PHP service looks something like the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="sr">/php/</span> <span class="kd">inherits</span> <span class="s">base</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$docroot</span> <span class="o">=</span> <span class="s2">&quot;/var/www/www&quot;</span>
</span><span class='line'>  <span class="nv">$syslog</span><span class="o">=</span><span class="s2">&quot;/var/log/apache2/error.log&quot;</span>
</span><span class='line'>  <span class="nv">$samlalias</span><span class="o">=</span><span class="s2">&quot;/var/www/&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span><span class="s1">&#39;php&#39;</span><span class="p">:}</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Notice the node name being a regex? (The parent node, <code>base</code> defines a set of common variables that are useful to all or multiple Puppet modules, such as the Message Broker URL, Java distribution name etc). That is what gets matched to the Puppet agent certificate&rsquo;s hostname.</p>

<p>Now that we have an overall understanding of the Puppet context in Stratos let&rsquo;s take a look at how Puppet configures and starts the services in a spawned instance&hellip;. in the next article!</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2015-03-17T04:25:03+05:30" pubdate data-updated="true">Mar 17<sup>th</sup>, 2015</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/apache-stratos/"><span class="badge">apache stratos</span></a>
          
          <a href="/blog/categories/cartridge-agent/"><span class="badge">cartridge agent</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">Apache Stratos Cartridge Agent: Day 0</a></h1>
      <p>As the first post of a series of comprehensive guide to the Apache Stratos Cartridge Agent, let&rsquo;s look at the Cartridge Agent contract. Keep tuned in and expect more detailed explanations on the instance and Cartridge Agent configuration, workflow, different Cartridge Agent implementations, their configurations and newly introduced plugin system in the Python implementation.</p>

<h1>Role of the Cartridge Agent</h1>

<p>When the instances are spawned in Apache Stratos, there are a few requirements that the particular instance should fulfill. It should</p>

<ol>
<li>Listen to the message broker events that are intended to it and publish events notifying any listening parties of its current state (STARTED|ACTIVATED|MAINTENANCE_MODE etc)</li>
<li>Check if the intended ports of the instance are active or not and publish the status accordingly</li>
<li>Periodically check the health statistics of the instance and publish them to an expecting <a href="http://code.chamiladealwis.com/blog/2014/10/10/thrift-communication-in-apache-stratos/">Thrift compatible</a> Complex Event Processor</li>
<li>Clone from and constantly update an artifact repository if specified</li>
</ol>


<p>It&rsquo;s obvious that there should be an independent common component in each instance that fulfills these requests. And just like that, we&rsquo;ve stated the case for the cartridge agent.</p>

<h2>Message broker communication</h2>

<p>Apache Stratos has a loosely-coupled component structure which executes the major communication bulk over a message broker. This enables any new component to join the chit-chat without disrupting the ongoing communication or without any impact on the configuration of the existing components. Any component can go silent and it wouldn&rsquo;t affect the communication channel. The communication happens via message broker <em>Events</em> and <em>Topics</em> in the common communication channel. Therefore each component should only be aware of the location (and sometimes the credentials) of the common communication channel, the message broker.</p>

<p>The Cartridge Agent connects to the message broker, publishes its initial status and listens to the <em>topics</em> for any events that are important to it. We&rsquo;ll see what these events are and what their impact would be on the work flow of the agent in the walk through section.</p>

<h2>Ports activity check</h2>

<p>For each cartridge, a set of ports are defined in the cartridge definition. The intended services should run on these ports. The agent should determine if a the intended service is up or not before it can announce that it is ready to accept requests. It does so by checking if the specified ports are active or not.</p>

<h2>Health statistics publishing</h2>

<p>The Cloud is about Scale, and Scale is about Health. Apache Stratos auto-scaling feature takes care of the complex scaling requirements of the deployed services based on a number of parameters, on a number of levels. From the point of the instance, its contribution to the scaling effort should be to announce its health status to the decision making process.</p>

<p>The agent does this by collecting the memory usage and the load average values of the running instance and publishing them to a real time Complex Event Processor via Apache Thrift protocol. (Why doesn&rsquo;t it use the broker channel? Well, it&rsquo;s too darn slow to begin with for a real time event to be <em>real time</em>. Hammer and the problem anyone?) It does this periodically, usually every 15 seconds. If an instance stops publishing health stats events and stays dark for more than 60 seconds, the Complex Event Processor considers that instance to be a hopeless case and announces that an instance has gone dark. The auto-scaler, upon receiving this announcement (an <em>Event</em> published on a <em>topic</em> as you might have guessed), issues orders to terminate the faulty instance and spawn a new instance to take the place of the fallen comrade.</p>

<h2>Artifacts Distribution</h2>

<p>Most cartridge types deal with a set of artifacts that are hosted on a remote repository, that should be copied over to the instance and executed on. For an example a PHP cartridge will require a remote repository location to copy the web artifacts from. It is the Cartridge Agent that performs this artifact management task. In addition to cloning from the remote repository, there are cases where the locally modified artifacts should be pushed to the remote repository. This is also carried out by the Cartridge Agent.</p>

<p>It is the responsibility of the Cartridge Agent to manage all the tasks and make sure the instance goes through its intended life cycle. But, who configures and starts the Cartridge Agent? Keeping aside the philosophical overtone of that question, let&rsquo;s take a look at the instance configuration process in the next article before diving in to the Cartridge Agent life cycle itself.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-10-10T15:33:51+05:30" pubdate data-updated="true">Oct 10<sup>th</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/apache-stratos/"><span class="badge">apache stratos</span></a>
          
          <a href="/blog/categories/thrift/"><span class="badge">thrift</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/10/10/thrift-communication-in-apache-stratos/">Thrift Communication in Apache Stratos</a></h1>
      <h1>Thrift Streaming Basics in WSO2 Carbon</h1>

<p>In Stratos, data publishing over Thrift is done via streaming. It uses WSO2 Carbon&rsquo;s Data Bridge to serialize data in to a stream and publish to a given Ip address and a Port. The use of DataBridge is explained <a href="http://wso2.com/library/articles/2012/07/creating-custom-agents-publish-events-bamcep/">here</a>.</p>

<h2>Stream Definition</h2>

<p>In order to publish data as a stream, the definition of the particular stream should be defined first. This is achieved using the <code>org.wso2.carbon.databridge.commons.StreamDefinition</code> class. The list of attributes that will be written to the stream is defined using a StreamDefinition object to be assigned to a particular DataPublisher.</p>

<p>One notable aspect of the StreamDefinition class is the three separate attribute list for metaData, correlationData and payloadData in that order. This separation of the attributes is a logical divide which doesn&rsquo;t have any significant meaning on the server side when it comes to WSO2 CEP and WSO2 BAM. It is available for the publisher to make sense of the various types of data that are being published and then later analyzed. This scenario in the WSO2 CEP context is explained <a href="http://stackoverflow.com/questions/26033755/what-is-meta-data-correlation-data-and-payload-data-in-wso2-cep">here</a>.</p>

<p>A StreamDefinition should minimally have a stream ID and a stream name. Additionally a nickname, and a description can be added. The stream ID is generated by the receiver when the StreamDefinition is associated with a particular connection. This constitutes of the stream name and the stream version. When publishing data this stream ID is used to retrieve the stream definition at the receiver&rsquo;s end. In fact the first two attributes to be published when publishing data are the stream ID of <code>STRING</code> type and the timestamp of the event in milliseconds of type <code>LONG</code>.</p>

<p>The attributes describing the data that is published have to added to the StreamDefinition <em>in the order they are to be published</em>. The order is important in a data stream because it is bound to the way the data is read from the receiver&rsquo;s side.</p>

<p>For each attribute added, the type of the data should be defined. WSO2 DataBridge provides readable attribute types that represents the <a href="http://thrift-tutorial.readthedocs.org/en/latest/thrift-types.html">type system in Thrift</a>, as <code>INT</code>, <code>LONG</code>, <code>FLOAT</code>, <code>DOUBLE</code>, <code>STRING</code> and <code>BOOL</code>.</p>

<h2>Data</h2>

<p>Data are written in to the stream as Events. <code>org.wso2.carbon.databridge.commons.Event</code> object stores the data for a particular event and when the time comes to actually serialize the data in to the wire, <code>org.wso2.carbon.databridge.agent.thrift.internal.utils.ThriftEventConverter</code> adds all the data together and assigns proper Thrift types to each data. This logic is implemented in the Carbon platform&rsquo;s DataBridge.</p>

<h1>Usage Scenarios</h1>

<p>Apache Stratos publishes data over Thrift in two scenarios. Both scenarios are involved with managing cartridges based on their performance. Cartridge Agent initiates and manages streaming of data from the cartridge to the monitoring server/complex event processing server. The addresses and the credentials of the data aggregation servers should be provided from Stratos to the cartridge agent.</p>

<h2>Health Statistics Publishing</h2>

<p><img src="/images/post_resource/thrift/healthstats.jpg"></p>

<p>Health statistics of a particular cartridge instance is used by a real time processing engine to declare events that manage the cartridge life cycle. For example based on the memory load and the CPU usage, CEP can publish events that the AutoScaling picks up and accordingly spawn new instances. Another example is the AutoScaler terminating faulty cartridges based on events published by the CEP when health statistics publishing stops for a certain period of timeout. The role of the AutoScaler along with a CEP is described <a href="https://cwiki.apache.org/confluence/display/STRATOS/4.1.0+Auto-scaler">here</a>.</p>

<p>Following values should be passed to the Cartridge Agent via the Puppet Configuration, which includes these values as system properties when the Cartridge Agent starts up. They are then used to establish the connection and publish the data to the Thrift receiver.</p>

<ol>
<li>Ip address (<code>thrift.receiver.ip</code>)</li>
<li>Port (<code>thrift.receiver.port</code>) &ndash; 7711 is the default value</li>
<li>Username(<code>thrift.server.admin.username</code>)</li>
<li>Password(<code>thrift.server.admin.password</code>)</li>
</ol>


<p>The Cartridge Agent publishes several events to the message broker after it starts, two key events being the InstanceStartedEvent and the InstanceActivatedEvent. The InstanceStartedEvent is published after the Topology is confirmed as consistent. The InstanceActivatedEvent is published after the InstanceStartedEvent, but this can happen in two code paths. If there is no repository based artifact management to be done, the InstanceActivatedEvent will be published immediately by the CartridgeAgent. If the Cartridge Agent has to wait for the ArtifactUpdatedEvent to start managing the artifacts related to a repository, the InstanceActivatedEvent will be published after the artifacts are synchronized to the instance. These events are published from the Cartridge Agent to the <code>/instance/status</code> topic in the message broker. In both cases the health statistics publishing job starts after the InstanceActivatedEvent is published. The interval at which the health statistics publishing job works can be adjusted by specifying <code>stats.notifier.interval</code> property of the cartridge agent. By default this is set to 15 seconds.</p>

<p>The health statistics are published with the stream name <code>cartridge_agent_health_stats</code>. The stream definition contains only the payload data and the types of the added payload data are as follows.</p>

<ol>
<li>&ldquo;cluster_id&rdquo;           => STRING</li>
<li>&ldquo;network_partition_id&rdquo; => STRING</li>
<li>&ldquo;member_id&rdquo;            => STRING</li>
<li>&ldquo;partition_id&rdquo;         => STRING</li>
<li>&ldquo;health_description&rdquo;   => STRING</li>
<li>&ldquo;value&rdquo;                => DOUBLE</li>
</ol>


<p>Two types of health statistics are published by the cartridge agent, percentage of free memory, and the load average of the CPU. <code>health_description</code> field uses values <code>memory_consumption</code> and <code>load_average</code> respectively for these two readings.</p>

<p>Health statistics publishing can be disabled by setting <code>cep.stats.publisher.enabled</code> property of the Cartridge agent to <code>false</code>.</p>

<h2>Log Publishing</h2>

<p><img src="/images/post_resource/thrift/logs.jpg"></p>

<p>The application logs are published to a monitoring server by the cartridge agent for data analysis. For this the property <code>enable.data.publisher</code> should be set to <code>true</code>.</p>

<p>The log publishing thread starts as soon as the cartridge agent initialization is complete. For it to connect to the Thrift receiver following fields have to be passed to the Cartridge Agent.</p>

<ol>
<li>Ip address (<code>monitoring.server.ip</code>)</li>
<li>Port (<code>monitoring.server.port</code>)</li>
<li>Secure Port (<code>monitoring.server.secure.port</code>)</li>
<li>Username (<code>monitoring.server.admin.username</code>)</li>
<li>Password (<code>monitoring.server.admin.password</code>)</li>
</ol>


<p>The stream definition for the log publishing is as follows. Note that one metaData attribute is added to the definition by the publisher. This contains the member ID of the particular instance that is publishing the data.</p>

<h4>MetaData</h4>

<ol>
<li>&ldquo;memberId&rdquo;   => STRING</li>
</ol>


<h4>PayloadData</h4>

<ol>
<li>&ldquo;tenantID&rdquo;   => STRING</li>
<li>&ldquo;serverName&rdquo; => STRING</li>
<li>&ldquo;appName&rdquo;    => STRING</li>
<li>&ldquo;logTime&rdquo;    => LONG</li>
<li>&ldquo;priority&rdquo;   => STRING</li>
<li>&ldquo;message&rdquo;    => STRING</li>
<li>&ldquo;logger&rdquo;     => STRING</li>
<li>&ldquo;ip&rdquo;         => STRING</li>
<li>&ldquo;instance&rdquo;   => STRING</li>
<li>&ldquo;stacktrace&rdquo; => STRING</li>
</ol>


<p>The log publisher stream is defined with the name of format <code>logs.{tenantId}.{cartridgeAlias}.yyyy.MM.dd</code>.</p>

<p>For each of the log that is mentioned under <code>log.file.paths</code> parameter a separate <code>org.apache.stratos.cartridge.agent.data.publisher.log.FileBasedLogPublisher</code> thread is started.</p>

<p>The FileBasedLogPublisher scans the log file for new lines and for each new line added, publishes a new Event to the Thrift receiver. Therefore there is no defined interval for the log publisher naturally.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-08-05T23:08:34+05:30" pubdate data-updated="true">Aug 5<sup>th</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/virtualization/"><span class="badge">virtualization</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/08/05/pppoe-on-virtualbox/">PPPOE on VirtualBox</a></h1>
      <p>A quick note!</p>

<p>If your internet connection comes as a PPPOE connection and it can&rsquo;t be selected on the drop down list when &ldquo;Bridged network&rdquo; is selected on Network tab of the VM settings in VirtualBox. You can create a host-only network and configure a static ip for eth0 on the guest OS to make it accessible to outside.</p>

<p>A host-only network virtualizes the network interface of the host OS and uses it as a loopback device to enable guest OS to communicate on their network and with the host<a href="https://www.virtualbox.org/manual/ch06.html">[1]</a>.</p>

<p>Go to VirtualBox preferences (Ctrl + G) and navigate to the Network tab. Click on the &ldquo;Host-Only network&rdquo; tab and add a new host-only network. On the dialog that comes, go to the &ldquo;DHCP Server&rdquo; tab and disable it. VirtualBox provides its own DHCP server so the guest OS are able to use it, but if you want a consistent IP disabling it is the best course. Note down the IP address of the host-only network and its netmask. You might want to restart the networking service on the host os. Issue an <code>ifconfig -a</code> and you will see the virtual loopback device being listed.</p>

<p>Go to your VM&rsquo;s settings and navigate to the &ldquo;Network&rdquo; tab. On the network adaptor you&rsquo;re going to use as the connection to the network, select &ldquo;Host-Only adaptor&rdquo; as the networking type to attach to. Then select the host-only network device we created in the VirtualBox preferences. Select &ldquo;Allow All&rdquo; for &ldquo;Promiscuous Mode&rdquo;.</p>

<p>Start your VM and login as a super user. Define<a href="https://wiki.debian.org/NetworkConfiguration#Configuring_the_interface_manually">[2]</a><a href="http://www.putorius.net/2012/10/how-to-configure-static-ip-address-in.html">[3]</a> the network interface you attached to the Host-Only network with a static IP in the network of the host-only network. Point the gateway to the IP address of the host-only network. Restart the network service and your guest OS will have an IP which is accessible from the host.</p>

<p><strong>Note</strong>: If you come across any issues when restarting the network service with an error message containing &ldquo;file exists&rdquo; it&rsquo;s possible that network devices and their mappings to network device names have been jumbled. Best course to take is to delete the rules file and reboot the machine to regenerate it. This issue is likely to occur in Ubuntu distributions before 12.04 or in RedHat distributions<a href="http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">[4]</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo rm -rv /etc/udev/rules.d/70-persistant-*
</span><span class='line'>sudo reboot
</span></code></pre></td></tr></table></div></figure>


<p>[1] &ndash; <a href="https://www.virtualbox.org/manual/ch06.html">https://www.virtualbox.org/manual/ch06.html</a></p>

<p>[2] &ndash; <a href="https://wiki.debian.org/NetworkConfiguration#Configuring_the_interface_manually">https://wiki.debian.org/NetworkConfiguration#Configuring_the_interface_manually</a></p>

<p>[3] &ndash; <a href="http://www.putorius.net/2012/10/how-to-configure-static-ip-address-in.html">http://www.putorius.net/2012/10/how-to-configure-static-ip-address-in.html</a></p>

<p>[4] &ndash; <a href="http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">http://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/</a></p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-07-19T18:27:13+05:30" pubdate data-updated="true">Jul 19<sup>th</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/esb/"><span class="badge">esb</span></a>
          
          <a href="/blog/categories/security/"><span class="badge">security</span></a>
          
          <a href="/blog/categories/web-services/"><span class="badge">web services</span></a>
          
          <a href="/blog/categories/wso2/"><span class="badge">wso2</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/07/19/consuming-a-service-secured-by-wso2-esb/">Consuming a Service Secured by WSO2 ESB</a></h1>
      <p>In the <a href="http://code.chamiladealwis.com/blog/2014/07/18/securing-a-web-service-with-wso2-esb/">last post</a> I explained the steps needed, although somewhat minimal, to secure an unsecured backend service with WSO2 ESB. In this post I will continue on to the client side of the communication explaining the minimal client needed to communicate with the secure proxy service we created and take a peak at the action going on under the hood.</p>

<h1>UsernameToken</h1>

<p>Before we dive in to the client side code let&rsquo;s take a look at the WS-Policy for the UsernameToken security we applied to our service.</p>

<p>Login to the WSO2 ESB <a href="https://localhost:9443/carbon">Management console</a> and go to the Proxy service we created. In the &ldquo;Quality of Service Configuration&rdquo; section there is a link to &ldquo;Policies&rdquo;. Go to it and click in the &ldquo;Edit Policy&rdquo; button in front of the SOAP12Binding sub section.</p>

<p>What we are interested here is the content inside the <code>&lt;sp:SignedSupportingTokens xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;</code> tag. This describes the authentication policy that is applied to the proxy service. Since we applied UsernameToken the content will be similar to the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;sp:SignedSupportingTokens</span> <span class="na">xmlns:sp=</span><span class="s">&quot;http://schemas.xmlsoap.org/ws/2005/07/securitypolicy&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;wsp:Policy&gt;</span>
</span><span class='line'>       <span class="nt">&lt;sp:UsernameToken</span> <span class="na">sp:IncludeToken=</span><span class="s">&quot;http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient&quot;</span><span class="nt">&gt;&lt;/sp:UsernameToken&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/wsp:Policy&gt;</span>
</span><span class='line'> <span class="nt">&lt;/sp:SignedSupportingTokens&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This policy is embedded in the WSDL of the secured proxy service we created so the consuming party can derive the security demands of the service from it.</p>

<h1>Writing the Java Client</h1>

<p>To access the secure proxy service the following requirements should be satisfied.</p>

<ol>
<li>The server certificate should be added to the trust store.</li>
<li>Axis2 modules and libraries of Apache Rampart and its dependencies should be provided</li>
<li>The username and the password for the account which is granted access to the proxy service should be provided.</li>
</ol>


<h2>Adding the certificate to the trust store</h2>

<p>As you might be aware in HTTPS the server has to provide a self-signed or CA signed certificate for its secure communication and the client has to add that certificate as trusted to its trust store. WSO2Carbon products come with a self-signed certificate and you can add that certificate to your trust store to initiate secure communication. For demo purposes we&rsquo;ll use the same trust store that WSO2 ESB uses so you will not be needing to extract and import the certificate to your own trust store.</p>

<p>In case you&rsquo;re using your own trust store, <a href="http://udaraliyanage.wordpress.com/2014/06/14/convert-wso2carbon-jks-into-pem-format-extract-certificate-and-private-key/">this article</a> by Udara Liyanage describes how to extract the server certificate from the keystore. After the certificate is extracted add it to your trust store. For this you can use the keytool command as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>keytool -import -alias wso2_esb_server -file /path/to/server-certificate-file.crt -keystore /path/to/trust-store.jks -storepass truststorepassword
</span></code></pre></td></tr></table></div></figure>


<p>You can use your own trust store and set the path to the keystore file in the code or you can use the Java runtime trust store which is located in <code>$JRE_HOME/lib/security</code>.</p>

<p>To verify that the certificate was added you can grep the list of certificates in the trust store.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>keytool -list -keystore /path/to/trust-store.jks -storepass truststorepassword <span class="p">|</span> grep wso2_esb_server
</span></code></pre></td></tr></table></div></figure>


<h2>Apache Rampart</h2>

<p>Apache Rampart handles the security aspects in Axis2 and is needed to make use of WS-Security.</p>

<p><a href="http://axis.apache.org/axis2/java/rampart/download.html">Download Rampart</a> and extract the zip file.</p>

<p>Inside the lib folder the rampart library and its dependencies are contained. Inside the modules folder rampart and rahas Axis2 modules are contained. Rampart libraries should be available in the Classpath of the Java client we are going to execute while the Rampart Axis2 modules should be available in an Axis2 repository.</p>

<p><a href="http://wso2.com/library/tutorials/axis2-repository/">An Axis2 repository</a> consist of the following folder structure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> repository
</span><span class='line'>   modules
</span><span class='line'>   services
</span><span class='line'>   conf
</span><span class='line'>      axis2.xml
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;ve downloaded and extracted Axis2 to be used as a standalone Axis2 server then you can use that location. Copy the module archive (.mar) files from the extracted rampart folder to the repository/modules folder.</p>

<p>In the client code we will be engaging the Rampart module to handle the WS-Security headers.</p>

<h2>Client Code</h2>

<p>Assuming the service and the operations described in the <a href="http://code.chamiladealwis.com/blog/2014/07/01/creating-a-web-service-using-apache-axis2-no-ide/">&ldquo;Creating a Web Service using Apache Axis2&rdquo;</a> article the following Java client can be used to access the secured proxy service.</p>

<p>Create the Stub and the CallbackHandler classes using the <code>wsdl2java</code> tool as described in the above mentioned article. You must use the WSDL of the secured proxy service for source generation. Then code the client as follows. Replace <code>ESB_HOME</code> and <code>AXIS2_HOME</code> with your own locations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">chamiladealwis</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">client</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.context.ConfigurationContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.context.ConfigurationContextFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleServiceSecureClient</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// set trust store path and password. </span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStore&quot;</span><span class="o">,</span>
</span><span class='line'>                    <span class="s">&quot;ESB_HOME/repository/resources/security/client-truststore.jks&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStorePassword&quot;</span><span class="o">,</span> <span class="s">&quot;wso2carbon&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// create the configuration context from an axis repository. </span>
</span><span class='line'>            <span class="n">ConfigurationContext</span> <span class="n">ctx</span> <span class="o">=</span>
</span><span class='line'>                                   <span class="n">ConfigurationContextFactory</span><span class="o">.</span><span class="na">createConfigurationContextFromFileSystem</span><span class="o">(</span><span class="s">&quot;AXIS2_HOME/repository&quot;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span> <span class="n">secureStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// set username and password to access the service</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// engage rampart module to set WS-Security headers.</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">engageModule</span><span class="o">(</span><span class="s">&quot;rampart&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// execute remote call</span>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span> <span class="n">addReq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span><span class="o">();</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum1</span><span class="o">(</span><span class="mi">45</span><span class="o">);</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum2</span><span class="o">(</span><span class="mi">53</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">AddResponse</span> <span class="n">addResponse</span> <span class="o">=</span> <span class="n">secureStub</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Response received : &quot;</span> <span class="o">+</span> <span class="n">addResponse</span><span class="o">.</span><span class="na">get_return</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have used the trust store that WSO2 ESB uses so we will not have to import the certificate used by the server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStore&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;ESB_HOME/repository/resources/security/client-truststore.jks&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStorePassword&quot;</span><span class="o">,</span> <span class="s">&quot;wso2carbon&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The ConfigurationContext is generated from the repository location. We have copied the Rampart and Rahas Axis2 modules to this repository to be used when later engageModule(&ldquo;rampart&rdquo;) is called.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">ConfigurationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ConfigurationContextFactory</span><span class="o">.</span><span class="na">createConfigurationContextFromFileSystem</span><span class="o">(</span><span class="s">&quot;AXIS2_HOME/repository&quot;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">SimpleServiceExampleProxyStub</span> <span class="n">secureStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">....</span>
</span><span class='line'><span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">engageModule</span><span class="o">(</span><span class="s">&quot;rampart&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The username and the password to the account that is allowed to use the secured proxy service is included.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that this code works with SOAP messages and WS-* standards. If you want to use the REST communication method use the following code. This code does not make use of Rampart module since authentication is done using HTTP Authorization header (Basic auth mechanism since we&rsquo;ve used UsernameToken policy in our proxy service).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">chamiladealwis</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">client</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.Constants</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.transport.http.HTTPConstants</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.transport.http.HttpTransportProperties</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.transport.http.HttpTransportProperties.Authenticator</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleServiceSecureClient</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStore&quot;</span><span class="o">,</span>
</span><span class='line'>                    <span class="s">&quot;/home/chamilad/dev/wso2esb-4.8.1/repository/resources/security/client-truststore.jks&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStorePassword&quot;</span><span class="o">,</span> <span class="s">&quot;wso2carbon&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span> <span class="n">secureStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// set credentials to the secure proxy service</span>
</span><span class='line'>            <span class="n">HttpTransportProperties</span><span class="o">.</span><span class="na">Authenticator</span> <span class="n">authenticator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Authenticator</span><span class="o">();</span>
</span><span class='line'>            <span class="n">authenticator</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">authenticator</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setProperty</span><span class="o">(</span><span class="n">HTTPConstants</span><span class="o">.</span><span class="na">AUTHENTICATE</span><span class="o">,</span> <span class="n">authenticator</span><span class="o">);</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setProperty</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Configuration</span><span class="o">.</span><span class="na">ENABLE_REST</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">VALUE_TRUE</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// execute remote call</span>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span> <span class="n">addReq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span><span class="o">();</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum1</span><span class="o">(</span><span class="mi">45</span><span class="o">);</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum2</span><span class="o">(</span><span class="mi">53</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">AddResponse</span> <span class="n">addResponse</span> <span class="o">=</span> <span class="n">secureStub</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Response received : &quot;</span> <span class="o">+</span> <span class="n">addResponse</span><span class="o">.</span><span class="na">get_return</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now get the backend service and the WSO2 ESB running and execute the client to see the results. If you use Wireshark or TCPMon you will observe that the communication between the client and the ESB is encrypted and thus not visible to outsiders while the communication between the ESB and the backend service is unencrypted.</p>

<h2>&ldquo;Unable to engage module : rampart&rdquo;</h2>

<p>If you get an error with the message &ldquo;Unable to engage module : rampart&rdquo; it is most likely because Axis2 cannot find the Rampart module archive files. Verify the following and try again.</p>

<ul>
<li>See that the repository location specified when creating the ConfigurationContext contains rampart<em>.mar and rahas</em>.mar files in the modules folder.</li>
<li>Check the Classpath locations to verify that rampart*.jar files are available.</li>
</ul>


<h1>Action Under the Hood</h1>

<p>Let us investigate the SOAP/REST messages that are used to communicate with the secured proxy service.</p>

<p>I used <a href="http://www.charlesproxy.com/documentation/proxying/ssl-proxying/">Charles Proxy</a> to capture the encrypted communication between the client and the ESB. For some reason (I&rsquo;m guessing <a href="http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html">this</a> to be the reason, but this is still to be verified. The cipher suite mentioned in the Server Hello packet is TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA.) Wireshark couldn&rsquo;t decrypt the captured packets even when the server&rsquo;s private key was provided. Charles Proxy can make use of SSL Proxying in which it produces its own certificates based on its root certificate to communicate as a man in the middle. Charles&#8217; root certificate should be added to the trust store that is used in our client.</p>

<p>The SOAP message that is sent from our client consists of the following SOAP header.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;soapenv:Header&gt;</span>
</span><span class='line'>    <span class="nt">&lt;wsse:Security</span> <span class="na">xmlns:wsse=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;</span> <span class="na">xmlns:wsu=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;</span> <span class="na">soapenv:mustUnderstand=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;wsu:Timestamp</span> <span class="na">wsu:Id=</span><span class="s">&quot;TS-1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Created&gt;</span>2014-08-02T09:00:56.439Z<span class="nt">&lt;/wsu:Created&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Expires&gt;</span>2014-08-02T09:05:56.439Z<span class="nt">&lt;/wsu:Expires&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/wsu:Timestamp&gt;</span>
</span><span class='line'>        <span class="nt">&lt;wsse:UsernameToken</span> <span class="na">wsu:Id=</span><span class="s">&quot;UsernameToken-2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsse:Username&gt;</span>admin<span class="nt">&lt;/wsse:Username&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsse:Password</span> <span class="na">Type=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText&quot;</span><span class="nt">&gt;</span>admin<span class="nt">&lt;/wsse:Password&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/wsse:UsernameToken&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/wsse:Security&gt;</span>
</span><span class='line'><span class="nt">&lt;/soapenv:Header&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the username and the password fields? Yes, the password is sent in plaint text over HTTPS therefore if somehow HTTPS is compromised the password will be visible. To overcome this the WS-Policy for WS-Security can be <a href="http://soasecurity.org/2014/03/19/securing-a-proxy-service-in-wso2-esb-1-1-using-hash-passwords-in-username-token">modified to use a password digest</a> instead of a plain text password.</p>

<p>The function of <code>&lt;wsu:Timestamp&gt;</code>, which in short is to prevent replay attacks, is best described <a href="http://hasini-gunasinghe.blogspot.com/2012/02/timestamp-in-ws-security-to-mitigate.html">here</a>.</p>

<p>WSO2 ESB will process and strip the WSSE:Security header from the message to forward it to the backend service. When the response comes from the backend service ESB will add the related WS-Security headers to the outgoing message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;soapenv:Header&gt;</span>
</span><span class='line'>    <span class="nt">&lt;wsse:Security</span> <span class="na">xmlns:wsse=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;</span> <span class="na">soapenv:mustUnderstand=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;wsu:Timestamp</span> <span class="na">xmlns:wsu=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;</span> <span class="na">wsu:Id=</span><span class="s">&quot;Timestamp-26&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Created&gt;</span>2014-08-02T09:00:56.704Z<span class="nt">&lt;/wsu:Created&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Expires&gt;</span>2014-08-02T09:05:56.704Z<span class="nt">&lt;/wsu:Expires&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/wsu:Timestamp&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/wsse:Security&gt;</span>
</span><span class='line'><span class="nt">&lt;/soapenv:Header&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you used REST instead of SOAP you will see the following HTTP headers in the outgoing message from your client.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>POST /services/SimpleServiceSecureExampleProxy.SimpleServiceSecureExampleProxyHttpsSoap12Endpoint HTTP/1.1
</span><span class='line'>Content-Type: application/xml; charset=UTF-8
</span><span class='line'>SOAPAction: urn:getItemsAvailable
</span><span class='line'>User-Agent: Axis2
</span><span class='line'>Transfer-Encoding: chunked
</span><span class='line'>Host: hostname:8243
</span><span class='line'>Authorization: Basic YWRtaW46YWRtaW4=
</span><span class='line'>Content-Length: 101
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;ns1:add</span> <span class="na">xmlns:ns1=</span><span class="s">&quot;http://client.ws.chamiladealwis.com&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ns1:num1&gt;</span>45<span class="nt">&lt;/ns1:itemName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ns1:num2&gt;</span>53<span class="nt">&lt;/ns1:clarkName&gt;</span>
</span><span class='line'><span class="nt">&lt;/ns1:add&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the HTTP &ldquo;Authorization&rdquo; header and the value &ldquo;Basic&rdquo;. The value after &ldquo;Basic&rdquo; is the base64 encoded string containing the username:password. You can decrypt the encoded string to verify this using any <a href="http://www5.rptea.com/base64/">online tool</a>.</p>

<p>There are many policies that can be used to secure a proxy service, and UsernameToken is just the simplest form. More complex policies involve defining custom password callback handlers to refer to resources like federated identity to authenticate server calls. UsernameToken deals with plain text passwords so it should be only used for development purposes and not for production.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-07-18T23:17:46+05:30" pubdate data-updated="true">Jul 18<sup>th</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/esb/"><span class="badge">esb</span></a>
          
          <a href="/blog/categories/security/"><span class="badge">security</span></a>
          
          <a href="/blog/categories/web-services/"><span class="badge">web services</span></a>
          
          <a href="/blog/categories/wso2/"><span class="badge">wso2</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/07/18/securing-a-web-service-with-wso2-esb/">Securing a Web Service with WSO2 ESB</a></h1>
      <p>WSO2 Enterprise Service Bus is one of the <a href="http://blog.samisa.org/2014/02/wso2-esb-performance-round-75.html">best performing implementations</a> for the Enterprise market. In this article I will briefly go through what it takes to secure an unsecured backend web service using WSO2 ESB as a mediator.</p>

<p>Security in Web Services is covered by the WS-Security standard. There are <a href="http://docs.oasis-open.org/ws-sx/security-policy/examples/ws-sp-usecases-examples-cd-01.html">various policies</a> such as simple username and password authentication and PKI certificates that can be used to secure a Web Service. The policy that will be used is described using the WS-Policy standard.</p>

<p>WSDL of the secured service will have the WS-Security policy embedded and the consumer will be able to filter out the WS-Security policy from it to implement the client side security demands.</p>

<p>For this example we will be using the basic UsernameToken with Plain Text password policy which is supported right out of the box by WSO2 ESB. Note that this policy is recommended only for pre-production environments because the password is communicated in plain text. WSO2 ESB supports by default twenty security scenarios and you can always customize the policy to your liking.</p>

<h1>Pre-requisites</h1>

<ol>
<li>Unsecured backend service</li>
<li>WSO2 ESB (4.8.1 is used in this article)</li>
</ol>


<h2>Backend Service</h2>

<p>For demo purposes get a simple Web Service running. Refer to my earlier post, <a href="http://code.chamiladealwis.com/blog/2014/07/01/creating-a-web-service-using-apache-axis2-no-ide/">Creating a Web Service using Apache Axis2</a>, for help.</p>

<h2>Setting up WSO2 ESB</h2>

<p><a href="http://wso2.com/products/enterprise-service-bus/">Download</a> WSO2 ESB and extract it. Go to its <code>bin</code> folder and execute <code>wso2server.sh</code>. After it is executed go to the <a href="https://localhost:9443/carbon">management console</a> and log in. The default username and password is <code>admin</code>.</p>

<h1>Creating the Proxy Service</h1>

<p>We will create a proxy service for the backend service and then secure it with the UsernameToken policy.</p>

<p>Go to the ESB <a href="https://localhost:9443/carbon">management console</a> and add a proxy service by clicking on &ldquo;Proxy Service&rdquo; under Services->Add menu of the Main tab.</p>

<p><img src="/images/post_resource/esb-new-proxy.jpg"></p>

<p>Choose either &ldquo;Pass Through Proxy&rdquo; or &ldquo;WSDL Based Proxy&rdquo;. Fill the details according to the following</p>

<h2>Pass Through Proxy</h2>

<p><img src="/images/post_resource/esb-pass-through-options.jpg"></p>

<ul>
<li><p>Proxy Service Name &ndash; Enter an identifying name for the Proxy service you&rsquo;re creating.</p></li>
<li><p>Target Endpoint &ndash; Select &ldquo;Enter URL&rdquo;. &ldquo;Pick From Registry&rdquo; option allows you to select the endpoint stored as a resource on the configuration registry or the governance registry. We will be entering the endpoint URL by hand.</p></li>
<li><p>Target URL &ndash; Copy the URL of the backend service. This will be the WSDL url on the Axis2 service you created without the <code>?wsdl</code> string at the end.</p></li>
<li><p>On the &ldquo;Publish WSDL Options&rdquo; select &ldquo;Specify source URL&rdquo; for &ldquo;Publishing WSDL&rdquo;</p></li>
<li><p>WSDL URI &ndash; Enter the WSDL URL for the backend service. Click on &ldquo;Test URI&rdquo; to test the connection.</p></li>
</ul>


<p>Click Next.</p>

<h2>WSDL Proxy</h2>

<p><img src="/images/post_resource/esb-wdl-based-options.jpg"></p>

<ul>
<li><p>Proxy Service Name &ndash; Enter an identifying name for the Proxy service you&rsquo;re creating.</p></li>
<li><p>WSDL URI &ndash; The URI of the WSDL of the backend service.</p></li>
<li><p>WSDL Service &ndash; This is the service name that is used in the WSDL as the identifier for the service. In the WSDL document this is the value for the attribute <code>name</code> in the <code>wsdl:service</code> tag.</p></li>
<li><p>WSDL Port &ndash; This is the endpoint that you&rsquo;re going to use for the proxy service. Normally three types of ports are exposed for a service. Those are</p>

<ul>
<li>SOAP1.1 Endpoint &ndash; ServiceNameHttpSoap11Endpoint</li>
<li>SOAP1.2 Endpoint &ndash; ServiceNameHttpSOap12Endpoint</li>
<li>HTTP REST Endpoint &ndash; ServiceNameHttpEndpoint</li>
</ul>
</li>
</ul>


<p>Use either SOAP 1.1 or SOAP 1.2 endpoint as the port. You can find the names under the <code>&lt;wsdl:service&gt;-&gt;&lt;wsdl:port&gt;</code> tags.</p>

<p>Click Next.</p>

<p>Your proxy service will be created. WSO2 ESB has a tool called &ldquo;Try It&rdquo; which can be used as a test tool for Web Services. <a href="https://localhost:9443/carbon/service-mgt/index.jsp?region=region1&amp;item=services_list_menu">Service list page</a> will have a link to the &ldquo;Try It&rdquo; console in front of each service. Test the proxy service you just created to verify that we can go ahead to the securing phase.</p>

<p>At this point you have an unsecured proxy service that does basically nothing as a mediator to the backend service. We need to secure the service with UsernameToken policy so that the ESB will handle security aspects and only pass SOAP messages back and forth to the backend service sans the WS-Security.</p>

<h1>Securing the Proxy Service</h1>

<p>If you list the services of the ESB you will see that the proxy service you created just now is marked as unsecured, with the unlocked padlock as the icon.</p>

<p><img src="/images/post_resource/esb-unsecured-proxy.jpg"></p>

<p>Click on that icon to secure the service. Select &ldquo;Yes&rdquo; in the next page and you will be presented with the policy types that WSO2 ESB supports right out of the box.</p>

<p><img src="/images/post_resource/esb-secure-service-options.jpg"></p>

<p>Select &ldquo;UsernameToken&rdquo; and click Next.</p>

<p>Select the user groups that are allowed to use the service. In this case select admin.</p>

<p><img src="/images/post_resource/esb-secure-users-options.jpg"></p>

<p>Voil! You have secured your proxy service. Run &ldquo;Try It&rdquo; again and enter the username and the password (in this case admin:admin) to consume the service. If you try to consume the service without entering the proper user credentials you will be presented with an AxisFault.</p>

<p>If you check the WSDL of the secured proxy service you will observe the embedded WS-Policy describing the WS-Security policy (UsernameToken in our case) in the top most part of the WSDL document. If you wish to edit this policy you can do so by selecting &ldquo;Edit Policy&rdquo; in the Policies page of the Proxy Service. I will go to details of customized policies in another article.</p>

<p>In the next article I will elaborate on how to code a client to consume the secured proxy service and how UsernameToken policy is represented in the WS-Security headers.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-07-09T22:25:05+05:30" pubdate data-updated="true">Jul 9<sup>th</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/ubuntu/"><span class="badge">ubuntu</span></a>
          
          <a href="/blog/categories/wireshark/"><span class="badge">wireshark</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/07/09/wireshark-crashing-in-ubuntu/">Wireshark Crashing in Ubuntu</a></h1>
      <p>If you have customized your ubuntu GTK theme, Wireshark would most likely crash as soon as scrollbars come in to play. I experienced this in Ubuntu 14.04 and found the solution to be disabling overlay scrollbars that come as the default.</p>

<p>To do this simply add an environment variable called LIBOVERLAY_SCROLLBAR with value 0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">LIBOVERLAY_SCROLLBAR</span><span class="o">=</span>0
</span></code></pre></td></tr></table></div></figure>


      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-07-07T12:26:35+05:30" pubdate data-updated="true">Jul 7<sup>th</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/esb/"><span class="badge">esb</span></a>
          
          <a href="/blog/categories/wso2/"><span class="badge">wso2</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/07/07/wso2-esb-sample-screw-ups/">WSO2 ESB Sample Screw Ups</a></h1>
      <p>We all know the feeling when we follow every instruction of a sample page to the letter and the results turn out to be a total <del>clusterf..</del> disaster.</p>

<p>Well, let me try to easy some of the pain by listing the following probable fixes and workarounds for the 100-odd samples of the renowned <a href="http://wso2.com/products/enterprise-service-bus/">WSO2 Enterprise Service Bus</a>.</p>

<blockquote><p>Keep in mind that this post will keep getting updated till I go through every sample.</p></blockquote>

<h1>Sample 50</h1>

<p>The synapse configuration file that is shipped with 4.8.1 has an error where asterisks are missing from a filter mediater regex. Therefore execution of the main sequence stops after failing to match any <code>To</code> SOAP headers.</p>

<h2>Fix</h2>

<p>Change the following line in <code>&lt;ESB_HOME&gt;/repository/samples/synapse_sample_50.xml</code> to include the asterisks.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">&quot;get-property(&#39;To&#39;)&quot;</span> <span class="na">regex=</span><span class="s">&quot;./StockQuote.&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The modified line should be as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;filter</span> <span class="na">source=</span><span class="s">&quot;get-property(&#39;To&#39;)&quot;</span> <span class="na">regex=</span><span class="s">&quot;.*/StockQuote.*&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Sample 57</h1>

<p>In ESB 4.8.1 running this sample would not result in the expected outcome and would throw an error similar to the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>org.apache.synapse.SynapseException: A LoadBalanceEventHandler has not been
</span><span class='line'>specified in the axis2.xml file for the domain apache.axis2.application.domain
</span><span class='line'>at
</span><span class='line'>org.apache.synapse.core.axis2.Axis2LoadBalanceMembershipHandler.setConfigurationContext(Axis2LoadBalanceMembershipHandler.java:77)
</span></code></pre></td></tr></table></div></figure>


<p>The reason for this is the incompatibility between the clustering mechanisms used in ESB 4.8.1 (HazelCast) and the sample Axis2 server (Apache Tribes) it ships with.</p>

<h2>Fix</h2>

<p>As <a href="http://wso2-oxygen-tank.10903.n7.nabble.com/Dev-Running-ESB-sample-57-td89484.html">this</a> email thread mentions this can be overcome by getting ESB 4.7.0 where the same clustering implementation is used that of the Axis2 server.</p>

<h1>Sample 60, 61, 62</h1>

<p>In ESB 4.8.1 the synapse configuration files for the samples 60, 61, and 62 are missing and the configurations that are on the sample pages are errorneous.
For an example in sample #61 the mentioned configuration refers to a property named <code>EP_LIST</code> while there&rsquo;s no external registry resource or inline defined property that is of the name EP_LIST.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;send&gt;</span>
</span><span class='line'>    <span class="nt">&lt;endpoint&gt;</span>
</span><span class='line'>        <span class="nt">&lt;recipientlist&gt;</span>
</span><span class='line'>            <span class="nt">&lt;endpoints</span> <span class="na">value=</span><span class="s">&quot;{get-property(&#39;EP_LIST&#39;)}&quot;</span> <span class="na">max-cache=</span><span class="s">&quot;20&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/recipientlist&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/endpoint&gt;</span>
</span><span class='line'><span class="nt">&lt;/send&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Fix</h2>

<p>However these synapse configuration files are present in the 4.7.0 release and they can be used to start the 4.8.1 ESB with the desired configuration.</p>

<h1>Sample 152</h1>

<p>You would probably get an error while trying to execute the client like the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>[2014-07-07 13:28:09,060] ERROR - ServerWorker Error processing POST request
</span><span class='line'>java.lang.NullPointerException: Tenant domain has not been set in CarbonContext
</span><span class='line'>    at org.wso2.carbon.caching.impl.CacheManagerFactoryImpl.getCacheManager(CacheManagerFactoryImpl.java:79)
</span><span class='line'>    at org.wso2.carbon.security.pox.POXSecurityHandler.getPOXCache(POXSecurityHandler.java:383)
</span><span class='line'>    at org.wso2.carbon.security.pox.POXSecurityHandler.invoke(POXSecurityHandler.java:179)
</span><span class='line'>    at org.apache.axis2.engine.Phase.invokeHandler(Phase.java:340)
</span><span class='line'>    at org.apache.axis2.engine.Phase.invoke(Phase.java:313)
</span><span class='line'>    at org.apache.axis2.engine.AxisEngine.invoke(AxisEngine.java:261)
</span><span class='line'>    at org.apache.axis2.engine.AxisEngine.receive(AxisEngine.java:167)
</span><span class='line'>    at org.apache.axis2.transport.http.HTTPTransportUtils.processHTTPPostRequest(HTTPTransportUtils.java:172)
</span><span class='line'>    at org.apache.synapse.transport.nhttp.ServerWorker.processEntityEnclosingMethod(ServerWorker.java:459)
</span><span class='line'>    at org.apache.synapse.transport.nhttp.ServerWorker.run(ServerWorker.java:279)
</span><span class='line'>    at org.apache.axis2.transport.base.threads.NativeWorkerPool$1.run(NativeWorkerPool.java:172)
</span><span class='line'>    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
</span><span class='line'>    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
</span><span class='line'>    at java.lang.Thread.run(Thread.java:722)
</span></code></pre></td></tr></table></div></figure>


<p>While I can&rsquo;t exactly pinpoint the cause of the error this happens due to the way we execute the samples. If you directly executed the sample #152 chances are that you wouldn&rsquo;t come across this. But if you started with a sample before #101 you&rsquo;d probably get this.</p>

<p>At sample #101 you have to enable the NHTTP configuration for Carbon. Non-Blocking HTTP is required to enable WS-ReliableMessaging so that the source can call the Web Service destination asynchronously.</p>

<p>You are instructed to enable NHTTP configuration by editing the <code>carbon.xml</code> file in <code>&lt;ESB_HOME&gt;/repository/conf/</code>.</p>

<figure class='code'><figcaption><span>carbon.xml start:253</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="c">&lt;!-- You are instructed to comment this line and enable the next one to enable NHTTP --&gt;</span>
</span><span class='line'><span class="nt">&lt;ConfigurationFile&gt;</span>${carbon.home}/repository/conf/axis2/axis2.xml<span class="nt">&lt;/ConfigurationFile&gt;</span>
</span><span class='line'><span class="nt">&lt;ConfigurationFile&gt;</span>${carbon.home}/repository/conf/axis2/axis2_nhttp.xml<span class="nt">&lt;/ConfigurationFile&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Fix</h2>

<p>To make the sample #152 run properly revert this change.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2014-07-01T16:38:50+05:30" pubdate data-updated="true">Jul 1<sup>st</sup>, 2014</time></h5>
          <div class="row-fluid">
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/axis2/"><span class="badge">axis2</span></a>
          
          <a href="/blog/categories/web-services/"><span class="badge">web services</span></a>
          
          <a href="/blog/categories/wso2/"><span class="badge">wso2</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2014/07/01/creating-a-web-service-using-apache-axis2-no-ide/">Creating a Web Service using Apache Axis2 [No IDE]</a></h1>
      <h1>Outline</h1>

<ol>
<li>Pre-requisites</li>
<li>Deploying Axis2</li>
<li>Writing the service class</li>
<li>Deploying the service</li>
<li>Verification</li>
</ol>


<h1>Pre-requisites</h1>

<p>We need Apache Axis2 running and a suitable container. You could also run Axis2 as a standalone server but for this let&rsquo;s use Tomcat as a container. So in the following order</p>

<ol>
<li>Download and install JDK7</li>
<li>Download and install Tomcat 7 (even 8 would do, but it seems as of now Tomcat 8 isn&rsquo;t being supported by Eclipse, so let&rsquo;s go with v7)</li>
<li>Download and install AXis2 on Tomcat</li>
</ol>


<h2>JDK7</h2>

<p>Download and extract the JDK tarball.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget --no-check-certificate --no-cookies --header <span class="s2">&quot;Cookie: oraclelicense=accept-securebackup-cookie&quot;</span> http://download.oracle.com/otn-pub/java/jdk/7u60-b19/jdk-7u60-linux-x64.tar.gz
</span><span class='line'>tar zxvf jdk-7u60-linux-x64.tar.gz
</span></code></pre></td></tr></table></div></figure>


<p>Add and modify the following lines in ~/.profile or /etc/profile (for system wide application) to add <code>JAVA_HOME</code> environment variable and it&rsquo;s bin folder to <code>$PATH</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/path/to/jdk/extraction
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$HOME</span>/bin:<span class="nv">$JAVA_HOME</span>/bin
</span></code></pre></td></tr></table></div></figure>


<p>Refresh the terminal session and check if Java is working</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> ~/.profile
</span><span class='line'>java -version
</span></code></pre></td></tr></table></div></figure>


<h2>Tomcat 7</h2>

<p>You could install tomcat through <code>apt-get</code> or manually.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install tomcat7
</span></code></pre></td></tr></table></div></figure>


<p>Or download and set paths manually.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://supergsego.com/apache/tomcat/tomcat-7/v7.0.54/bin/apache-tomcat-7.0.54.tar.gz
</span><span class='line'>tar zxvf apache-tomcat-7.0.54.tar.gz
</span><span class='line'>mv apache-tomcat-7.0.54 ~/dev/
</span></code></pre></td></tr></table></div></figure>


<p>Add the <code>$CATALINA_HOME</code> env var to the bash profile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vi ~/.profile
</span></code></pre></td></tr></table></div></figure>


<p>Prepend the following line before exporting the $PATH.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">CATALINA_HOME</span><span class="o">=</span><span class="nv">$HOME</span>/dev/apache-tomcat-7.0.54
</span></code></pre></td></tr></table></div></figure>


<p>Server start/stop can be done by the scripts in the <code>$CATALINA_HOME/bin</code> folder.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$CATALINA_HOME</span>
</span><span class='line'>./bin/startup.sh
</span></code></pre></td></tr></table></div></figure>


<h1>Deploying Axis2</h1>

<p>Download Axis2 WAR distribution and copy the web archive file to the tomcat webapps root.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://apache.tradebit.com/pub//axis/axis2/java/core/1.6.2/axis2-1.6.2-war.zip
</span><span class='line'>unzip axis2-1.6.2-war.zip -d axis2-war
</span><span class='line'>cp axis2-war/axis2.war <span class="nv">$CATALINA_HOME</span>/webapps/
</span><span class='line'><span class="nb">cd</span> <span class="nv">$CATALINA_HOME</span>/bin
</span><span class='line'>./shutdown.sh
</span><span class='line'>./startup.sh
</span></code></pre></td></tr></table></div></figure>


<p>In the browser go to <a href="http://localhost:8080/axis2">http://localhost:8080/axis2</a>. Axis2 welcome page should appear.</p>

<h1>The Service</h1>

<p>An Axis2 archive (of <code>.aar</code> extension) has a certain directory structure not so different from a Web Archive.</p>

<figure class='code'><figcaption><span>Axis2 Archive Directory Structure start:1 linenos:false mark:4,9</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>.
</span><span class='line'> SimpleService
</span><span class='line'>     META-INF
</span><span class='line'>       services.xml
</span><span class='line'>     com
</span><span class='line'>       chamiladealwis
</span><span class='line'>         ws
</span><span class='line'>           service
</span><span class='line'>             SimpleService.java
</span></code></pre></td></tr></table></div></figure>


<p>META-INF folder contains the services descriptor file. The other is the binary which implements the service.</p>

<p>The service class itself is a plain old Java class which exposes the services it offers through public methods. My simple service would be the following.</p>

<figure class='code'><figcaption><span>SimpleService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">chamiladealwis</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleService</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">num1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">num2</span><span class="o">)</span>
</span><span class='line'>  <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">num1</span><span class="o">+</span><span class="n">num2</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>SimpleService</code> offers just one service  named <code>add</code> which accepts two Integer parameters and returns the sum of them as an Integer.</p>

<p>Now this service needs a service descriptor which exposes the service class to Axis2 when asked.</p>

<figure class='code'><figcaption><span>services.xml mark:3</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;service&gt;</span>
</span><span class='line'>    <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">&quot;ServiceClass&quot;</span> <span class="na">locked=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        com.chamiladealwis.ws.service.SimpleService
</span><span class='line'>    <span class="nt">&lt;/parameter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;operation</span> <span class="na">name=</span><span class="s">&quot;sayHello&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;messageReceiver</span> <span class="na">class=</span><span class="s">&quot;org.apache.axis2.rpc.receivers.RPCMessageReceiver&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/operation&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/service&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>A parameter named <code>ServiceClass</code> is defined with value <code>com.chamiladealwis.ws.service.SimpleService</code> which the FQN of the Java class we just wrote.</p>

<p>Now compile sources, create the Axis2 archive and deploy it in the Axis Server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># go to the root dir and compile the sources</span>
</span><span class='line'>javac com/chamiladealwis/ws/service/*.java
</span><span class='line'>
</span><span class='line'><span class="c"># create the archive file</span>
</span><span class='line'>jar cvf SimpleService.aar *
</span><span class='line'>
</span><span class='line'><span class="c"># copy the archive over to the Axis2 web root</span>
</span><span class='line'>cp SimpleService.aar <span class="nv">$CATALINE_HOME</span>/webapps/axis2/WEB-INF/services/
</span><span class='line'>
</span><span class='line'><span class="c"># restart tomcat</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$CATALINA_HOME</span>/bin
</span><span class='line'>./shutdown.sh
</span><span class='line'>./startup.sh
</span></code></pre></td></tr></table></div></figure>


<p>Browse to <a href="http://localhost:8080/axis2/services/listServices">http://localhost:8080/axis2/services/listServices</a> in your browser and you will see <code>SimpleService</code> being listed as an availble service with <code>add</code> as an operation.</p>

<p>Click on the link to <code>SimpleService</code> to view the WSDL file which will describe the service and it&rsquo;s operation in an abstracted XML interpretation that can be used to create clients in any language to consume the service.</p>

<h1>The Client</h1>

<p>The client code has to make use of a &ldquo;Stub&rdquo; of the service which will act as a proxy and a communication agent. Axis2 binary distribution includes tools which can generate the Java stub using the WSDL file as the source.</p>

<p>Download the Axis2 binary distribution, extract it and set <code>AXIS2_HOME</code> environment variable to its root. Add <code>$AXIS2_HOME</code> to <code>$PATH</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget http://apache.spinellicreations.com//axis/axis2/java/core/1.6.2/axis2-1.6.2-bin.zip
</span><span class='line'>unzip axis2-1.6.2-bin.zip
</span><span class='line'><span class="nb">pwd</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add the <code>$AXIS2_HOME</code> variable before <code>export PATH</code> line and modify <code>$PATH</code> to include <code>$AXIS2_HOME/bin</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">export </span><span class="nv">AXIS2_HOME</span><span class="o">=</span>/path/to/axis2/binary/folder
</span><span class='line'><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;$PATH:$AXIS2_HOME/bin&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now refresh terminal by sourcing the .profile file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">source</span> ~/.profile
</span><span class='line'><span class="nb">echo</span> <span class="nv">$AXIS2_HOME</span>
</span></code></pre></td></tr></table></div></figure>


<p>Copy the WSDL path of the <code>SimpleService</code>, go to the directory you&rsquo;re going to create your client code and execute the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./wsdl2java.sh -uri WSDL_PATH_OF_THE_SIMPLESERVICE -o client
</span></code></pre></td></tr></table></div></figure>


<p>The WSDL path would be something similar to <code>http://localhost:8080/axis2/services/SimpleService?wsdl</code>.</p>

<p>This will create the Java stub and the CallbackHandler classes. The CallbackHandler class can be extended to implement custom success and error callback executions. The Stub is the class of main importance here. It contains the Request and Response types of the operations available from the Service it was generated from and the skeletol methods that call to the target endpoint once invoked. We will use these members to call our simple service.</p>

<figure class='code'><figcaption><span>SimpleServiceClient.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">chamiladealwis</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">client</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.AxisFault</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.chamiladealwis.ws.client.SimpleServiceStub.Add</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">com.chamiladealwis.ws.client.SimpleServiceStub.AddResponse</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleClient</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Create the Stub object</span>
</span><span class='line'>            <span class="n">SimpleServiceStub</span> <span class="n">serviceStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceStub</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Create the Request object. The request class is autogenerated</span>
</span><span class='line'>            <span class="c1">// as an inner class of the Stub class.</span>
</span><span class='line'>            <span class="n">Add</span> <span class="n">addReq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Add</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Set parameters</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum1</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum2</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Invoke method and get response as a response object</span>
</span><span class='line'>            <span class="n">AddResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">serviceStub</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Response object&#39;s get_return() returns the return of the remote </span>
</span><span class='line'>            <span class="c1">// method</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">get_return</span><span class="o">();</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Sum : &quot;</span> <span class="o">+</span> <span class="n">sum</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="o">(</span><span class="n">AxisFault</span> <span class="n">e</span><span class="o">)</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s go through the client code.</p>

<p>Consuming an operation available through a Web Service consists of following steps.</p>

<ul>
<li>Create an object of the stub. All method calls will be invoked through this object.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">SimpleServiceStub</span> <span class="n">serviceStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceStub</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create the request object. This will have methods to add input parameters to the request.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Add</span> <span class="n">addReq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Add</span><span class="o">();</span>
</span><span class='line'><span class="n">addReq</span><span class="o">.</span><span class="na">setNum1</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
</span><span class='line'><span class="n">addReq</span><span class="o">.</span><span class="na">setNum2</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Invoke and the operation method. The operation method will be invoked through the stub object and the invocation accepts a parameter of type of request object.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">serviceStub</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Catch the response object. The invocation will return the response object mainly containing the value returned by the operation.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">AddResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="n">serviceStub</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Extract the return value. By calling <code>get_return()</code> of the response object the return value can be extracted.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">get_return</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you see it&rsquo;s pretty straightforward, although there are couple of things to keep in mind.</p>

<ol>
<li>You have to regenerate the client stubs everytime you change most of the server code (obviously).</li>
<li>It&rsquo;s good to check if the service has been properly deployed by going to the services page and checking the WSDL generation.</li>
<li>This was a <em>simple</em> client with <em>simple</em> input and output types. When complex types are involved there are some standards to be practiced. Be mindful that Web Services operate on a language and platform agnostic environment.</li>
<li><em>You will not be writing web services and clients this way most of the time!</em> But that&rsquo;s a topic for another post :)</li>
</ol>


      
      
    </div>
  </div>



    </article>
    
  
  <div class="pagination">
    
    <a class="prev" href="2">&larr; Older</a>
    

    
  </div>
</div>


        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2015 - chamila de alwis -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'chamila-01';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
