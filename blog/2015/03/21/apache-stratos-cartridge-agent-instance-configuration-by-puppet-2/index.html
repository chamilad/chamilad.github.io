
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Apache Stratos Cartridge Agent: Instance Configuration by Puppet 2 - nuts!</title>
  <meta name="author" content="chamila de alwis">

  
  <meta name="description" content="This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the first &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chamilad.github.io/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="nuts!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab:300' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  

</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h2>nuts!</h2>
  
    <h1>Ramblings on Cloud Computing, Middleware and Beer</h1>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chamilad.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Apache Stratos Cartridge Agent: Instance Configuration by Puppet 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-21T23:25:09+05:30" pubdate data-updated="true">Mar 21<sup>st</sup>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>This is a part of a series of articles on Apache Stratos Cartridge Agent. If you feel like you&rsquo;ve missed the memo, why not start from the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-contract/">first article</a>?</p></blockquote>

<p>One of the main responsibilities of the Cartridge Agent is to start the services related the Cartridge type. To do this the Cartridge Agent should be configured with proper parameters. As we discussed in the <a href="http://code.chamiladealwis.com/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/">last article</a>, Puppet can be used to install, configure and start the Cartridge Agent. In this article, we will discuss how this is done in detail.</p>

<h1>Configurations</h1>

<p>The Cartridge Agent needs several parameters to start functioning correctly.</p>

<ol>
<li>Message broker IP address and port</li>
<li>Complex Event Processor IP address and port</li>
<li>Application path (for repository based cartridges)</li>
</ol>


<p>In addition to these parameters, there are several others which might be crucial to Cartridge Agent life cycle, based on different scenarios. However, at minimum, it needs the details of the above mentioned parameters to successfully function.</p>

<p>For orchestration in the VM scenario, we provide these values to Puppet, which in turn will configure the Cartridge Agent accordingly.</p>

<h2>base.pp</h2>

<p>The purpose of the <code>base.pp</code> in <code>/etc/puppet/manifests/nodes/</code> folder is to serve as a super node definition which can be inherited by service type node definitions. It contains a list of variables that can be used by any module that inherits it. As of Stratos 4.1.0 release the contents of the <code>base.pp</code> file looks like as follows. The variables are pretty much self explanatory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'><span class="kd">node</span> <span class="s1">&#39;base&#39;</span> <span class="p">{</span><span class="c-Singleline"></span>
</span><span class='line'>
</span><span class='line'><span class="c-Singleline">  #essential variables</span>
</span><span class='line'>  <span class="nv">$package_repo</span>         <span class="o">=</span> <span class="s1">&#39;http://10.4.128.7&#39;</span>
</span><span class='line'>  <span class="nv">$local_package_dir</span>    <span class="o">=</span> <span class="s1">&#39;/mnt/packs&#39;</span>
</span><span class='line'>  <span class="nv">$mb_url</span>               <span class="o">=</span> <span class="s1">&#39;tcp://127.0.0.1:1883&#39;</span>
</span><span class='line'>  <span class="nv">$mb_type</span>              <span class="o">=</span> <span class="s1">&#39;activemq&#39;</span><span class="c-Singleline"> #in wso2 mb case, value should be &#39;wso2mb&#39;</span>
</span><span class='line'>  <span class="nv">$cep_ip</span>               <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'>  <span class="nv">$cep_port</span>             <span class="o">=</span> <span class="s1">&#39;7711&#39;</span>
</span><span class='line'>  <span class="nv">$cep_username</span>         <span class="o">=</span><span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$cep_password</span>         <span class="o">=</span><span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$truststore_password</span>  <span class="o">=</span> <span class="s1">&#39;wso2carbon&#39;</span>
</span><span class='line'>  <span class="nv">$java_distribution</span>    <span class="o">=</span> <span class="s1">&#39;jdk-7u51-linux-x64.tar.gz&#39;</span>
</span><span class='line'>  <span class="nv">$java_name</span>            <span class="o">=</span> <span class="s1">&#39;jdk1.7.0_51&#39;</span>
</span><span class='line'>  <span class="nv">$member_type_ip</span>       <span class="o">=</span> <span class="s1">&#39;private&#39;</span>
</span><span class='line'>  <span class="nv">$lb_httpPort</span>          <span class="o">=</span> <span class="s1">&#39;80&#39;</span>
</span><span class='line'>  <span class="nv">$lb_httpsPort</span>         <span class="o">=</span> <span class="s1">&#39;443&#39;</span>
</span><span class='line'>  <span class="nv">$tomcat_version</span>       <span class="o">=</span> <span class="s1">&#39;7.0.52&#39;</span>
</span><span class='line'>  <span class="nv">$enable_log_publisher</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
</span><span class='line'>  <span class="nv">$bam_ip</span>               <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span><span class='line'>  <span class="nv">$bam_port</span>             <span class="o">=</span> <span class="s1">&#39;7611&#39;</span>
</span><span class='line'>  <span class="nv">$bam_secure_port</span>      <span class="o">=</span> <span class="s1">&#39;7711&#39;</span>
</span><span class='line'>  <span class="nv">$bam_username</span>         <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$bam_password</span>         <span class="o">=</span> <span class="s1">&#39;admin&#39;</span>
</span><span class='line'>  <span class="nv">$metadata_service_url</span> <span class="o">=</span> <span class="s1">&#39;https://127.0.0.1:9443&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kn">require</span> <span class="nc">stratos_base</span>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The <code>base.pp</code> file should be modified to include proper values when the Puppet master is configured.</p>

<h2>Cartridge Agent modules</h2>

<p>Apache Stratos 4.1.0 ships with two implementations of the Cartridge Agent, default Java agent and a Python based agent. The respective Puppet modules for these implementations are <code>agent</code> and <code>python_agent</code> inside <code>/etc/puppet/modules</code> folder.</p>

<p>Both modules have a similar flow of execution, where there are separate steps to,</p>

<ol>
<li>Copy the Cartridge Agent distribution from the Puppet master to the instance</li>
<li>Copy templates reflecting configuration files, Cartridge Agent extensions and plugins, and configure parameters as given by <code>base.pp</code> and calling modules</li>
<li>Start Cartridge Agent</li>
</ol>


<p>If a calling module (the module which includes the Cartridge Agent module, typically a service type like PHP) needs to override a value provided through base.pp it can do so by assigning the new value to the variable at the time of Puppet module inclusion.</p>

<h3>Cartridge Agent Extensions and Plugins</h3>

<p>In addition to <a href="http://code.chamiladealwis.com/2015/03/17/apache-stratos-cartridge-agent-contract/">what the Cartridge Agent does as a generic agent to all services</a>, each service can make use of extensions, and in the Python implementation, plugins to add additional behavior to it. We will go in to more details about the extensions and plugins in a separate article, however you only need to be aware of them as being executed for specified events that are processed by the Cartridge Agent. For example, you can have an extension that can be specified to be executed, when an ArtifactUpdatedEvent is processed by the Cartridge Agent.</p>

<p>For each service that includes the Puppet module for a certain implementation of the Cartridge Agent, it can specify a list of extensions and plugins that should be copied over to the Cartridge Agent. For example, this is how the PHP module specifies the list of plugins and extensions that should be included in the Cartridge Agent, when the running service is PHP.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='puppet'><span class='line'>  <span class="nv">$custom_agent_templates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;extensions/artifacts-updated.sh&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nv">$custom_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;plugins/PhpServerStarterPlugin.py&#39;</span><span class="p">,</span> <span class="s1">&#39;plugins/PhpServerStarterPlugin.yapsy-plugin&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="nc">class</span> <span class="p">{</span><span class="s1">&#39;python_agent&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="nt">custom_templates</span> <span class="p">=&gt;</span> <span class="nv">$custom_agent_templates</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">custom_plugins</span> <span class="p">=&gt;</span> <span class="nv">$custom_plugins</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">module</span><span class="p">=&gt;</span><span class="s1">&#39;php&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>While the Cartridge Agent is executing, these specified extensions and plugins will be executed when their respective events are processed.</p>

<p>As mentioned above, it is the responsibility of the Cartridge Agent to start the respective services related to the spawned Cartridge. This is also done using a Cartridge Agent plugin (Python implementation) or an extension (Java implementation).</p>

<h1>Conclusion for Configuration</h1>

<p>By the end of this article, we should be aware of the details of the configuration needed by the Cartridge Agent. At least, that was my intention. If you feel like I&rsquo;ve missed a crucial explanation, feel free to drop a comment.</p>

<p>As of now, Apache Stratos only supports Puppet as a configuration tool for Cartridge instances. However in the future releases, it will also be possible use Chef, or another similar tool as a replacement for Puppet.</p>

<p>From this point onwards, we will start on the details of the Cartridge Agent life cycle execution. For that we will first go through a typical work flow of a PHP Cartridge instance&hellip;. in the next article!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (Chamila de Alwis)" rel="author">Chamila de Alwis</a></span></span>

      








  


<time datetime="2015-03-21T23:25:09+05:30" pubdate data-updated="true">Mar 21<sup>st</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-stratos/'>apache stratos</a> <a class='category label label-primary' href='/blog/categories/cartridge-agent/'>cartridge agent</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://chamilad.github.io/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2/" data-via="chamilad" data-counturl="http://chamilad.github.io/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/03/17/apache-stratos-cartridge-agent-instance-configuration-by-puppet/" title="Previous Post: Apache Stratos Cartridge Agent: Instance Configuration by Puppet 1">&laquo; Apache Stratos Cartridge Agent: Instance Configuration by Puppet 1</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/03/22/apache-stratos-cartridge-agent-life-cycle-walkthough/" title="next Post: Apache Stratos Cartridge Agent: Life Cycle Walkthough">Apache Stratos Cartridge Agent: Life Cycle Walkthough &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - chamila de alwis -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chamila-01';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chamilad.github.io/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2/';
        var disqus_url = 'http://chamilad.github.io/blog/2015/03/21/apache-stratos-cartridge-agent-instance-configuration-by-puppet-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
