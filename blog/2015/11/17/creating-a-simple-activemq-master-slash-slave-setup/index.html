
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Creating a Simple ActiveMQ Master/Slave Setup - nuts!</title>
  <meta name="author" content="chamila">

  
  <meta name="description" content="ActiveMQ is a high performing message broker, however if clustering is needed, it supports a number of methods. Out of these, the Master/Slave is a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chamilad.github.io/blog/2015/11/17/creating-a-simple-activemq-master-slash-slave-setup">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="nuts!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab:300' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.0.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
  

</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <a href="/"><h2>nuts!</h2></a>
  
    <h1>Ramblings on Cloud Computing, Middleware and Beer</h1>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chamilad.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Creating a Simple ActiveMQ Master/Slave Setup</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-17T17:11:12+05:30" pubdate data-updated="true">Nov 17<sup>th</sup>, 2015</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-activemq/'>apache activemq</a>
  
</span>


        
      </p>
    
  </header>


<div class="entry-content"><p>ActiveMQ is a high performing message broker, however if clustering is needed, it supports <a href="http://activemq.apache.org/clustering.html">a number of methods</a>. Out of these, the <a href="http://activemq.apache.org/masterslave.html">Master/Slave</a> is a pattern where the persistence layer is shared between multiple broker instances. A Single <code>Master</code> broker connects to the persistence, and the rest of the <code>Slave</code> brokers keep waiting to attain the lock on the persistence. If the Master node goes down the lock for the persistence is released and a Slave quickly acquires it, allowing a client to continue operation without any data loss. The clients should connect to the Master/Slave setup, using the <code>failover:</code> transport, or they should implement a manual failover mechanism to automatically connect to the next available broker when the first one goes down.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='properties'><span class='line'><span class="na">connectionfactoryName</span><span class="o">=</span><span class="s">TopicConnectionFactory</span>
</span><span class='line'><span class="na">java.naming.provider.url</span><span class="o">=</span><span class="s">failover:(tcp://localhost:61617,tcp://localhost:61618,tcp://localhost:61619)?initialReconnectDelay=100</span>
</span><span class='line'><span class="na">java.naming.factory.initial</span><span class="o">=</span><span class="s">org.apache.activemq.jndi.ActiveMQInitialContextFactory</span>
</span></code></pre></td></tr></table></div></figure>


<h1>How to Setup a Master/Slave</h1>

<p>Let&rsquo;s setup two broker instances in the same machine. The two instances will open different ports for the protocols, so there will be no conflicts. They will use the flat file based embedded KahaDB as the persistence layer and the two instances will share the KahaDB instance.</p>

<h2>Creating Two Broker Instances</h2>

<p>Unzip the ActiveMQ distribution to two places and offset port values in the second one to use different ports so that there will be no conflicts for ports used by the different protocol connectors. The places to change are in <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code> and <code>&lt;ACTIVEMQ_HOME&gt;/conf/jetty.xml</code>.</p>

<figure class='code'><figcaption><span>activemq.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;transportConnectors&gt;</span>
</span><span class='line'>    <span class="c">&lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;openwire&quot;</span> <span class="na">uri=</span><span class="s">&quot;tcp://0.0.0.0:61626?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;amqp&quot;</span> <span class="na">uri=</span><span class="s">&quot;amqp://0.0.0.0:5682?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;stomp&quot;</span> <span class="na">uri=</span><span class="s">&quot;stomp://0.0.0.0:61623?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;mqtt&quot;</span> <span class="na">uri=</span><span class="s">&quot;mqtt://0.0.0.0:1893?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">&quot;ws&quot;</span> <span class="na">uri=</span><span class="s">&quot;ws://0.0.0.0:61624?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/transportConnectors&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>jetty.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jettyPort&quot;</span> <span class="na">class=</span><span class="s">&quot;org.apache.activemq.web.WebConsolePort&quot;</span> <span class="na">init-method=</span><span class="s">&quot;start&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- the default port number for the web console --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;host&quot;</span> <span class="na">value=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;port&quot;</span> <span class="na">value=</span><span class="s">&quot;8171&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s point the KahaDB persistence to the same location. This will result in only one instance at a time being able to acquire the lock to the DB and when the lock is released the other instance will be able get it from the same location.</p>

<p>Modify the <code>persistenceAdapter</code> tag inside <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code> as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;persistenceAdapter&gt;</span>
</span><span class='line'>    <span class="nt">&lt;kahaDB</span> <span class="na">directory=</span><span class="s">&quot;/tmp/mq/kahadb&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/persistenceAdapter&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do this change for both of the instances.</p>

<p>Now, let&rsquo;s introduce the two instances to each other by adding a <code>networkConnector</code> pointing to each other. Add the following block to the <code>&lt;ACTIVEMQ_HOME&gt;/conf/activemq.xml</code> after the <code>persistenceAdapter</code> block in the master.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;networkConnectors&gt;</span>
</span><span class='line'>    <span class="nt">&lt;networkConnector</span> <span class="na">uri=</span><span class="s">&quot;static:(tcp://localhost:61626)&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/networkConnectors&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Port <code>61626</code> is the OpenWire port in the Slave instance. Similarly add the same block in the Slave <code>activemq.xml</code> file, pointing to the Master&rsquo;s OpenWire port. Static discovery is used here to statically point to the existing broker instances.</p>

<h2>Starting the instances</h2>

<p>Now let&rsquo;s start the Master broker instance.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> &lt;ACTIVEMQ_HOME&gt;/bin
</span><span class='line'>./activemq start
</span><span class='line'><span class="c"># tail the logs just for the fun of it</span>
</span><span class='line'>tail -100f ../data/activemq.log
</span></code></pre></td></tr></table></div></figure>


<p>When observing the logs you will see some log entries similar to the following repeatedly appearing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2015-11-17 19:10:19,731 <span class="p">|</span> INFO  <span class="p">|</span> Establishing network connection from vm://localhost?async<span class="o">=</span><span class="nb">false</span><span class="p">&amp;</span><span class="nv">network</span><span class="o">=</span><span class="nb">true </span>to tcp://localhost:61626 <span class="p">|</span> org.apache.activemq.network.DiscoveryNetworkConnector <span class="p">|</span> ActiveMQ Task-61
</span><span class='line'>2015-11-17 19:10:19,733 <span class="p">|</span> INFO  <span class="p">|</span> Connector vm://localhost started <span class="p">|</span> org.apache.activemq.broker.TransportConnector <span class="p">|</span> ActiveMQ Task-61
</span><span class='line'>2015-11-17 19:10:19,736 <span class="p">|</span> INFO  <span class="p">|</span> localhost Shutting down <span class="p">|</span> org.apache.activemq.network.DemandForwardingBridgeSupport <span class="p">|</span> ActiveMQ BrokerService<span class="o">[</span>localhost<span class="o">]</span> Task-134
</span><span class='line'>2015-11-17 19:10:19,738 <span class="p">|</span> INFO  <span class="p">|</span> localhost bridge to Unknown stopped <span class="p">|</span> org.apache.activemq.network.DemandForwardingBridgeSupport <span class="p">|</span> ActiveMQ BrokerService<span class="o">[</span>localhost<span class="o">]</span> Task-134
</span><span class='line'>2015-11-17 19:10:19,739 <span class="p">|</span> INFO  <span class="p">|</span> Connector vm://localhost stopped <span class="p">|</span> org.apache.activemq.broker.TransportConnector <span class="p">|</span> ActiveMQ Task-61
</span><span class='line'>2015-11-17 19:10:19,741 <span class="p">|</span> WARN  <span class="p">|</span> Could not start network bridge between: vm://localhost?async<span class="o">=</span><span class="nb">false</span><span class="p">&amp;</span><span class="nv">network</span><span class="o">=</span><span class="nb">true </span>and: tcp://localhost:61626 due to: Connection refused <span class="p">|</span> org.apache.activemq.network.DiscoveryNetworkConnector <span class="p">|</span> ActiveMQ Task-61
</span></code></pre></td></tr></table></div></figure>


<p>This is because we &ldquo;introduced&rdquo; the Slave broker to the Master broker and now it&rsquo;s looking for it.</p>

<p>Now start the Slave broker and tail the logs. You will see a different set of logs appearing.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2015-11-17 18:34:37,359 <span class="p">|</span> INFO  <span class="p">|</span> Database /tmp/mq/kahadb/lock is locked... waiting 10 seconds <span class="k">for </span>the database to be unlocked. Reason: java.io.IOException: File <span class="s1">&#39;/tmp/mq/kahadb/lock&#39;</span> could not be locked. <span class="p">|</span> org.apache.activemq.store.SharedFileLocker <span class="p">|</span> main
</span></code></pre></td></tr></table></div></figure>


<p>This is because the lock for the shared DB is already acquired by the Master broker. The Slave broker will not start until it is able to acquire the lock for the DB. If you try to see which ports are open using the <code>netstat</code> command you will see that only the Master broker is up and running and ready to accept requests.</p>

<p>Now if you connect to the broker setup using the <code>failover:</code> transport you will see that the client connected the Master broker. Create a queue and publish an event to the queue without consuming it. Now stop the Master broker. You will see the Slave broker acquiring the lock to the DB and become ready to accept requests. Start a consumer with the <code>failover</code> transport and observe it connecting to and retrieving the event (which was published to the Master broker) from the Slave broker. There was no data loss and the service didn&rsquo;t stop responding for more than a few moments which the Slave took to start up after acquiring the DB lock.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>

      








  


<time datetime="2015-11-17T17:11:12+05:30" pubdate data-updated="true">Nov 17<sup>th</sup>, 2015</time>
      

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/apache-activemq/'>apache activemq</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://chamilad.github.io/blog/2015/11/17/creating-a-simple-activemq-master-slash-slave-setup/" data-via="chamilad" data-counturl="http://chamilad.github.io/blog/2015/11/17/creating-a-simple-activemq-master-slash-slave-setup/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/11/16/support-for-activemq-master-slash-slave-failover-in-apache-stratos-cartridge-agent/" title="Previous Post: Support for ActiveMQ Master/Slave failover in Apache Stratos Cartridge Agent">&laquo; Support for ActiveMQ Master/Slave failover in Apache Stratos Cartridge Agent</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/11/26/timing-out-of-long-running-methods-in-python/" title="next Post: Timing out of long running methods in Python">Timing out of long running methods in Python &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - chamila -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chamila-01';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chamilad.github.io/blog/2015/11/17/creating-a-simple-activemq-master-slash-slave-setup/';
        var disqus_url = 'http://chamilad.github.io/blog/2015/11/17/creating-a-simple-activemq-master-slash-slave-setup/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
