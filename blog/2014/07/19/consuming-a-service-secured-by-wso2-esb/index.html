
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Consuming a Service Secured by WSO2 ESB - nuts!</title>
  <meta name="author" content="chamila">

  
  <meta name="description" content="In the last post I explained the steps needed, although somewhat minimal, to secure an unsecured backend service with WSO2 ESB. In this post I will &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chamilad.github.io/blog/2014/07/19/consuming-a-service-secured-by-wso2-esb">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="nuts!" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Roboto+Slab:300' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  

</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <a href="/"><h2>nuts!</h2></a>
  
    <h1>Ramblings on Cloud Computing, Middleware and Beer</h1>
  
</hgroup>

</header>
  <nav role="navigation">
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chamilad.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Consuming a Service Secured by WSO2 ESB</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-19T18:27:13+05:30" pubdate data-updated="true">Jul 19<sup>th</sup>, 2014</time> 
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>
 

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/esb/'>esb</a> <a class='category label label-primary' href='/blog/categories/security/'>security</a> <a class='category label label-primary' href='/blog/categories/web-services/'>web services</a> <a class='category label label-primary' href='/blog/categories/wso2/'>wso2</a>
  
</span>


        
      </p>
    
  </header>


<div class="entry-content"><p>In the <a href="http://code.chamiladealwis.com/blog/2014/07/18/securing-a-web-service-with-wso2-esb/">last post</a> I explained the steps needed, although somewhat minimal, to secure an unsecured backend service with WSO2 ESB. In this post I will continue on to the client side of the communication explaining the minimal client needed to communicate with the secure proxy service we created and take a peak at the action going on under the hood.</p>

<h1>UsernameToken</h1>

<p>Before we dive in to the client side code let&rsquo;s take a look at the WS-Policy for the UsernameToken security we applied to our service.</p>

<p>Login to the WSO2 ESB <a href="https://localhost:9443/carbon">Management console</a> and go to the Proxy service we created. In the &ldquo;Quality of Service Configuration&rdquo; section there is a link to &ldquo;Policies&rdquo;. Go to it and click in the &ldquo;Edit Policy&rdquo; button in front of the SOAP12Binding sub section.</p>

<p>What we are interested here is the content inside the <code>&lt;sp:SignedSupportingTokens xmlns:sp="http://schemas.xmlsoap.org/ws/2005/07/securitypolicy"&gt;</code> tag. This describes the authentication policy that is applied to the proxy service. Since we applied UsernameToken the content will be similar to the following.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;sp:SignedSupportingTokens</span> <span class="na">xmlns:sp=</span><span class="s">&quot;http://schemas.xmlsoap.org/ws/2005/07/securitypolicy&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;wsp:Policy&gt;</span>
</span><span class='line'>       <span class="nt">&lt;sp:UsernameToken</span> <span class="na">sp:IncludeToken=</span><span class="s">&quot;http://schemas.xmlsoap.org/ws/2005/07/securitypolicy/IncludeToken/AlwaysToRecipient&quot;</span><span class="nt">&gt;&lt;/sp:UsernameToken&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/wsp:Policy&gt;</span>
</span><span class='line'> <span class="nt">&lt;/sp:SignedSupportingTokens&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This policy is embedded in the WSDL of the secured proxy service we created so the consuming party can derive the security demands of the service from it.</p>

<h1>Writing the Java Client</h1>

<p>To access the secure proxy service the following requirements should be satisfied.</p>

<ol>
<li>The server certificate should be added to the trust store.</li>
<li>Axis2 modules and libraries of Apache Rampart and its dependencies should be provided</li>
<li>The username and the password for the account which is granted access to the proxy service should be provided.</li>
</ol>


<h2>Adding the certificate to the trust store</h2>

<p>As you might be aware in HTTPS the server has to provide a self-signed or CA signed certificate for its secure communication and the client has to add that certificate as trusted to its trust store. WSO2Carbon products come with a self-signed certificate and you can add that certificate to your trust store to initiate secure communication. For demo purposes we&rsquo;ll use the same trust store that WSO2 ESB uses so you will not be needing to extract and import the certificate to your own trust store.</p>

<p>In case you&rsquo;re using your own trust store, <a href="http://udaraliyanage.wordpress.com/2014/06/14/convert-wso2carbon-jks-into-pem-format-extract-certificate-and-private-key/">this article</a> by Udara Liyanage describes how to extract the server certificate from the keystore. After the certificate is extracted add it to your trust store. For this you can use the keytool command as follows.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>keytool -import -alias wso2_esb_server -file /path/to/server-certificate-file.crt -keystore /path/to/trust-store.jks -storepass truststorepassword
</span></code></pre></td></tr></table></div></figure>


<p>You can use your own trust store and set the path to the keystore file in the code or you can use the Java runtime trust store which is located in <code>$JRE_HOME/lib/security</code>.</p>

<p>To verify that the certificate was added you can grep the list of certificates in the trust store.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>keytool -list -keystore /path/to/trust-store.jks -storepass truststorepassword <span class="p">|</span> grep wso2_esb_server
</span></code></pre></td></tr></table></div></figure>


<h2>Apache Rampart</h2>

<p>Apache Rampart handles the security aspects in Axis2 and is needed to make use of WS-Security.</p>

<p><a href="http://axis.apache.org/axis2/java/rampart/download.html">Download Rampart</a> and extract the zip file.</p>

<p>Inside the lib folder the rampart library and its dependencies are contained. Inside the modules folder rampart and rahas Axis2 modules are contained. Rampart libraries should be available in the Classpath of the Java client we are going to execute while the Rampart Axis2 modules should be available in an Axis2 repository.</p>

<p><a href="http://wso2.com/library/tutorials/axis2-repository/">An Axis2 repository</a> consist of the following folder structure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>└── repository
</span><span class='line'>    ├── modules
</span><span class='line'>    ├── services
</span><span class='line'>    └── conf
</span><span class='line'>       └── axis2.xml
</span></code></pre></td></tr></table></div></figure>


<p>If you&rsquo;ve downloaded and extracted Axis2 to be used as a standalone Axis2 server then you can use that location. Copy the module archive (.mar) files from the extracted rampart folder to the repository/modules folder.</p>

<p>In the client code we will be engaging the Rampart module to handle the WS-Security headers.</p>

<h2>Client Code</h2>

<p>Assuming the service and the operations described in the <a href="http://code.chamiladealwis.com/blog/2014/07/01/creating-a-web-service-using-apache-axis2-no-ide/">&ldquo;Creating a Web Service using Apache Axis2&rdquo;</a> article the following Java client can be used to access the secured proxy service.</p>

<p>Create the Stub and the CallbackHandler classes using the <code>wsdl2java</code> tool as described in the above mentioned article. You must use the WSDL of the secured proxy service for source generation. Then code the client as follows. Replace <code>ESB_HOME</code> and <code>AXIS2_HOME</code> with your own locations.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">chamiladealwis</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">client</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.context.ConfigurationContext</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.context.ConfigurationContextFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleServiceSecureClient</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// set trust store path and password. </span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStore&quot;</span><span class="o">,</span>
</span><span class='line'>                    <span class="s">&quot;ESB_HOME/repository/resources/security/client-truststore.jks&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStorePassword&quot;</span><span class="o">,</span> <span class="s">&quot;wso2carbon&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// create the configuration context from an axis repository. </span>
</span><span class='line'>            <span class="n">ConfigurationContext</span> <span class="n">ctx</span> <span class="o">=</span>
</span><span class='line'>                                   <span class="n">ConfigurationContextFactory</span><span class="o">.</span><span class="na">createConfigurationContextFromFileSystem</span><span class="o">(</span><span class="s">&quot;AXIS2_HOME/repository&quot;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span> <span class="n">secureStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// set username and password to access the service</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// engage rampart module to set WS-Security headers.</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">engageModule</span><span class="o">(</span><span class="s">&quot;rampart&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// execute remote call</span>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span> <span class="n">addReq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span><span class="o">();</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum1</span><span class="o">(</span><span class="mi">45</span><span class="o">);</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum2</span><span class="o">(</span><span class="mi">53</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">AddResponse</span> <span class="n">addResponse</span> <span class="o">=</span> <span class="n">secureStub</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Response received : &quot;</span> <span class="o">+</span> <span class="n">addResponse</span><span class="o">.</span><span class="na">get_return</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have used the trust store that WSO2 ESB uses so we will not have to import the certificate used by the server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStore&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;ESB_HOME/repository/resources/security/client-truststore.jks&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStorePassword&quot;</span><span class="o">,</span> <span class="s">&quot;wso2carbon&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The ConfigurationContext is generated from the repository location. We have copied the Rampart and Rahas Axis2 modules to this repository to be used when later engageModule(&ldquo;rampart&rdquo;) is called.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">ConfigurationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">ConfigurationContextFactory</span><span class="o">.</span><span class="na">createConfigurationContextFromFileSystem</span><span class="o">(</span><span class="s">&quot;AXIS2_HOME/repository&quot;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">SimpleServiceExampleProxyStub</span> <span class="n">secureStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">....</span>
</span><span class='line'><span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">engageModule</span><span class="o">(</span><span class="s">&quot;rampart&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The username and the password to the account that is allowed to use the secured proxy service is included.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setUserName</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that this code works with SOAP messages and WS-* standards. If you want to use the REST communication method use the following code. This code does not make use of Rampart module since authentication is done using HTTP Authorization header (Basic auth mechanism since we&rsquo;ve used UsernameToken policy in our proxy service).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">chamiladealwis</span><span class="o">.</span><span class="na">ws</span><span class="o">.</span><span class="na">client</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.rmi.RemoteException</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.Constants</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.transport.http.HTTPConstants</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.transport.http.HttpTransportProperties</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.axis2.transport.http.HttpTransportProperties.Authenticator</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleServiceSecureClient</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStore&quot;</span><span class="o">,</span>
</span><span class='line'>                    <span class="s">&quot;/home/chamilad/dev/wso2esb-4.8.1/repository/resources/security/client-truststore.jks&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">&quot;javax.net.ssl.trustStorePassword&quot;</span><span class="o">,</span> <span class="s">&quot;wso2carbon&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span> <span class="n">secureStub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// set credentials to the secure proxy service</span>
</span><span class='line'>            <span class="n">HttpTransportProperties</span><span class="o">.</span><span class="na">Authenticator</span> <span class="n">authenticator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Authenticator</span><span class="o">();</span>
</span><span class='line'>            <span class="n">authenticator</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">authenticator</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setProperty</span><span class="o">(</span><span class="n">HTTPConstants</span><span class="o">.</span><span class="na">AUTHENTICATE</span><span class="o">,</span> <span class="n">authenticator</span><span class="o">);</span>
</span><span class='line'>            <span class="n">secureStub</span><span class="o">.</span><span class="na">_getServiceClient</span><span class="o">().</span><span class="na">getOptions</span><span class="o">().</span><span class="na">setProperty</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">Configuration</span><span class="o">.</span><span class="na">ENABLE_REST</span><span class="o">,</span> <span class="n">Constants</span><span class="o">.</span><span class="na">VALUE_TRUE</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// execute remote call</span>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span> <span class="n">addReq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">Add</span><span class="o">();</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum1</span><span class="o">(</span><span class="mi">45</span><span class="o">);</span>
</span><span class='line'>            <span class="n">addReq</span><span class="o">.</span><span class="na">setNum2</span><span class="o">(</span><span class="mi">53</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">SimpleServiceExampleProxyStub</span><span class="o">.</span><span class="na">AddResponse</span> <span class="n">addResponse</span> <span class="o">=</span> <span class="n">secureStub</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">addReq</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Response received : &quot;</span> <span class="o">+</span> <span class="n">addResponse</span><span class="o">.</span><span class="na">get_return</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now get the backend service and the WSO2 ESB running and execute the client to see the results. If you use Wireshark or TCPMon you will observe that the communication between the client and the ESB is encrypted and thus not visible to outsiders while the communication between the ESB and the backend service is unencrypted.</p>

<h2>&ldquo;Unable to engage module : rampart&rdquo;</h2>

<p>If you get an error with the message &ldquo;Unable to engage module : rampart&rdquo; it is most likely because Axis2 cannot find the Rampart module archive files. Verify the following and try again.</p>

<ul>
<li>See that the repository location specified when creating the ConfigurationContext contains rampart<em>.mar and rahas</em>.mar files in the modules folder.</li>
<li>Check the Classpath locations to verify that rampart*.jar files are available.</li>
</ul>


<h1>Action Under the Hood</h1>

<p>Let us investigate the SOAP/REST messages that are used to communicate with the secured proxy service.</p>

<p>I used <a href="http://www.charlesproxy.com/documentation/proxying/ssl-proxying/">Charles Proxy</a> to capture the encrypted communication between the client and the ESB. For some reason (I&rsquo;m guessing <a href="http://vincent.bernat.im/en/blog/2011-ssl-perfect-forward-secrecy.html">this</a> to be the reason, but this is still to be verified. The cipher suite mentioned in the Server Hello packet is TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA.) Wireshark couldn&rsquo;t decrypt the captured packets even when the server&rsquo;s private key was provided. Charles Proxy can make use of SSL Proxying in which it produces its own certificates based on its root certificate to communicate as a man in the middle. Charles&#8217; root certificate should be added to the trust store that is used in our client.</p>

<p>The SOAP message that is sent from our client consists of the following SOAP header.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;soapenv:Header&gt;</span>
</span><span class='line'>    <span class="nt">&lt;wsse:Security</span> <span class="na">xmlns:wsse=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;</span> <span class="na">xmlns:wsu=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;</span> <span class="na">soapenv:mustUnderstand=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;wsu:Timestamp</span> <span class="na">wsu:Id=</span><span class="s">&quot;TS-1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Created&gt;</span>2014-08-02T09:00:56.439Z<span class="nt">&lt;/wsu:Created&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Expires&gt;</span>2014-08-02T09:05:56.439Z<span class="nt">&lt;/wsu:Expires&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/wsu:Timestamp&gt;</span>
</span><span class='line'>        <span class="nt">&lt;wsse:UsernameToken</span> <span class="na">wsu:Id=</span><span class="s">&quot;UsernameToken-2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsse:Username&gt;</span>admin<span class="nt">&lt;/wsse:Username&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsse:Password</span> <span class="na">Type=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-username-token-profile-1.0#PasswordText&quot;</span><span class="nt">&gt;</span>admin<span class="nt">&lt;/wsse:Password&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/wsse:UsernameToken&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/wsse:Security&gt;</span>
</span><span class='line'><span class="nt">&lt;/soapenv:Header&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice the username and the password fields? Yes, the password is sent in plaint text over HTTPS therefore if somehow HTTPS is compromised the password will be visible. To overcome this the WS-Policy for WS-Security can be <a href="http://soasecurity.org/2014/03/19/securing-a-proxy-service-in-wso2-esb-1-1-using-hash-passwords-in-username-token">modified to use a password digest</a> instead of a plain text password.</p>

<p>The function of <code>&lt;wsu:Timestamp&gt;</code>, which in short is to prevent replay attacks, is best described <a href="http://hasini-gunasinghe.blogspot.com/2012/02/timestamp-in-ws-security-to-mitigate.html">here</a>.</p>

<p>WSO2 ESB will process and strip the WSSE:Security header from the message to forward it to the backend service. When the response comes from the backend service ESB will add the related WS-Security headers to the outgoing message.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;soapenv:Header&gt;</span>
</span><span class='line'>    <span class="nt">&lt;wsse:Security</span> <span class="na">xmlns:wsse=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd&quot;</span> <span class="na">soapenv:mustUnderstand=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;wsu:Timestamp</span> <span class="na">xmlns:wsu=</span><span class="s">&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;</span> <span class="na">wsu:Id=</span><span class="s">&quot;Timestamp-26&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Created&gt;</span>2014-08-02T09:00:56.704Z<span class="nt">&lt;/wsu:Created&gt;</span>
</span><span class='line'>            <span class="nt">&lt;wsu:Expires&gt;</span>2014-08-02T09:05:56.704Z<span class="nt">&lt;/wsu:Expires&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/wsu:Timestamp&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/wsse:Security&gt;</span>
</span><span class='line'><span class="nt">&lt;/soapenv:Header&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you used REST instead of SOAP you will see the following HTTP headers in the outgoing message from your client.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>POST /services/SimpleServiceSecureExampleProxy.SimpleServiceSecureExampleProxyHttpsSoap12Endpoint HTTP/1.1
</span><span class='line'>Content-Type: application/xml; charset=UTF-8
</span><span class='line'>SOAPAction: urn:getItemsAvailable
</span><span class='line'>User-Agent: Axis2
</span><span class='line'>Transfer-Encoding: chunked
</span><span class='line'>Host: hostname:8243
</span><span class='line'>Authorization: Basic YWRtaW46YWRtaW4=
</span><span class='line'>Content-Length: 101
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;ns1:add</span> <span class="na">xmlns:ns1=</span><span class="s">&quot;http://client.ws.chamiladealwis.com&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ns1:num1&gt;</span>45<span class="nt">&lt;/ns1:itemName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;ns1:num2&gt;</span>53<span class="nt">&lt;/ns1:clarkName&gt;</span>
</span><span class='line'><span class="nt">&lt;/ns1:add&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the HTTP &ldquo;Authorization&rdquo; header and the value &ldquo;Basic&rdquo;. The value after &ldquo;Basic&rdquo; is the base64 encoded string containing the username:password. You can decrypt the encoded string to verify this using any <a href="http://www5.rptea.com/base64/">online tool</a>.</p>

<p>There are many policies that can be used to secure a proxy service, and UsernameToken is just the simplest form. More complex policies involve defining custom password callback handlers to refer to resources like federated identity to authenticate server calls. UsernameToken deals with plain text passwords so it should be only used for development purposes and not for production.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (chamila)" rel="author">chamila</a></span></span>

      








  


<time datetime="2014-07-19T18:27:13+05:30" pubdate data-updated="true">Jul 19<sup>th</sup>, 2014</time>
      

<span class="categories">
  
    <a class='category label label-primary' href='/blog/categories/esb/'>esb</a> <a class='category label label-primary' href='/blog/categories/security/'>security</a> <a class='category label label-primary' href='/blog/categories/web-services/'>web services</a> <a class='category label label-primary' href='/blog/categories/wso2/'>wso2</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://chamilad.github.io/blog/2014/07/19/consuming-a-service-secured-by-wso2-esb/" data-via="chamilad" data-counturl="http://chamilad.github.io/blog/2014/07/19/consuming-a-service-secured-by-wso2-esb/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/18/securing-a-web-service-with-wso2-esb/" title="Previous Post: Securing a Web Service with WSO2 ESB">&laquo; Securing a Web Service with WSO2 ESB</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/08/05/pppoe-on-virtualbox/" title="next Post: PPPOE on VirtualBox">PPPOE on VirtualBox &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - chamila -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chamila-01';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://chamilad.github.io/blog/2014/07/19/consuming-a-service-secured-by-wso2-esb/';
        var disqus_url = 'http://chamilad.github.io/blog/2014/07/19/consuming-a-service-secured-by-wso2-esb/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
